<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Rece√ß√£o Cozinha</title>
    <link rel="stylesheet" href="css/login.css" />
    <link rel="stylesheet" href="css/header.css" />
  </head>

  <body>
    <header>
      <div class="logo-title">
        <img src="" alt="Logo" class="logo" />
      </div>

      <div class="links-container">
        <form id="loginForm" class="login-form">
          <input
            type="text"
            name="username"
            placeholder="Email Moloni"
            required
          />
          <input
            type="password"
            name="password"
            placeholder="Senha Moloni"
            required
          />
          <button type="submit" class="btn btn-primary">Login</button>
        </form>

        <nav id="navLinks">
          <a href="./login.html" class="protected"> Rece√ß√£o Bar </a>
          <a href="./rececaoCozi.html" class="protected active">
            Rece√ß√£o Cozinha
          </a>
          <a href="./cozinha.html" class="protected"> Cozinha </a>
          <a href="./faturas.html" class="protected">üìÑ Ver Faturas</a>
          <!-- Layout principal: 2 colunas
          <a href="./guiasTransporte.html" class="protected"

            >üöö Guias de Transporte
          </a>
 -->

          <a href="./artigos.html" class="protected">üçΩÔ∏è Gerir Pratos</a>
          <a href="./menu.html" class="protected">üìã Menu</a>
        </nav>
      </div>

      <div id="tokenDisplay" class="token-status">
        ‚ö†Ô∏è Sistema n√£o autenticado
      </div>
    </header>
    <div id="mainContent" style="display: none">
      <h1>Rece√ß√£o Cozinha</h1>

      <button class="btn protected" onclick="openCreateTableModal()">
        Abrir Nova Mesa
      </button>

      <!-- Layout principal: 2 colunas -->
      <div
        class="main-layout"
        style="display: flex; gap: 20px; margin-top: 20px; align-items: stretch"
      >
        <!-- Coluna esquerda: mesas abertas/fechadas -->
        <div
          class="table-lists"
          style="
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-left: 15px;
          "
        >
          <div class="table-section">
            <h3>Mesas Abertas</h3>
            <div id="openTables"></div>
          </div>

          <div class="table-section">
            <h3>Mesas Fechadas</h3>
            <div id="closedTables"></div>
          </div>
        </div>

        <!-- Coluna direita: detalhes do pedido -->
        <div
          class="order-details"
          id="orderDetails"
          style="
            flex: 2;
            border-left: 1px solid #ccc;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            margin-bottom: 15px;
          "
        >
          <p>Selecione uma mesa para ver os detalhes do pedido</p>
        </div>
      </div>

      <div id="createTableModal" class="modal">
        <div class="modal-content">
          <!-- Left Column: Small (Table Info) -->
          <div class="modal-left">
            <h3>Abrir Nova Mesa</h3>

            <label for="newTableName">Nome da Mesa:</label>
            <input
              type="text"
              id="newTableName"
              placeholder="(Dropdown das mesas do restaurante)"
            />

            <div class="modal-actions">
              <button
                class="btn btn-secondary"
                onclick="closeCreateTableModal()"
              >
                Cancelar
              </button>
              <button
                class="btn btn-primary"
                id="saveTableBtn"
                onclick="createNewTable()"
              >
                Abrir Mesa
              </button>
            </div>
          </div>

          <!-- Right Column: Big (Categories + Pratos) -->
          <div class="modal-right">
            <h3>Selecionar Pratos</h3>
            <!-- üîπ t√≠tulo fixo -->

            <div class="category-section">
              <h4>Pratos Principais</h4>
              <div id="principalArticles" class="article-list"></div>
            </div>

            <div class="category-section">
              <h4>Pratos Secund√°rios</h4>
              <div id="secondaryArticles" class="article-list"></div>
            </div>

            <div class="category-section">
              <h4>Acompanhamentos</h4>
              <div id="sideArticles" class="article-list"></div>
            </div>

            <div class="category-section">
              <h4>Sobremesas</h4>
              <div id="dessertArticles" class="article-list"></div>
            </div>

            <div class="category-section">
              <h4>Bebidas</h4>
              <div id="drinkArticles" class="article-list"></div>
            </div>

            <div class="category-section">
              <h4>Extras</h4>
              <div id="extraArticles" class="article-list"></div>
            </div>
          </div>
        </div>
      </div>
      <div id="invoiceModal" class="modal">
        <div class="modal-content">
          <div class="modal-right">
            <h3>Emitir Documento</h3>

            <label for="modalInvoiceType">Tipo:</label>
            <select
              id="modalInvoiceType"
              style="width: 100%; margin-bottom: 10px"
            >
              <option value="FR">Fatura/Recibo</option>
              <option value="FS">Fatura Simplificada</option>
              <option value="FT">Fatura</option>
            </select>

            <label for="modalInvoiceNif">NIF (opcional):</label>
            <input
              type="text"
              id="modalInvoiceNif"
              placeholder="999999990"
              style="width: 100%; margin-bottom: 10px"
            />

            <label for="modalInvoiceNotes">Notas:</label>
            <textarea
              id="modalInvoiceNotes"
              rows="4"
              style="width: 100%"
            ></textarea>

            <div class="modal-actions">
              <button onclick="closeModal()">Cancelar</button>
              <button onclick="confirmEmitirFatura()">Confirmar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      async function parseJsonOrThrow(response) {
        const text = await response.text();
        try {
          return JSON.parse(text);
        } catch (e) {
          throw new Error(
            `Resposta n√£o-JSON (${response.status} ${
              response.statusText
            }): ${text.slice(0, 300)}`
          );
        }
      }
      async function loginMoloni() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const loginStatus = document.getElementById("loginStatus");

        if (!username || !password) {
          loginStatus.textContent = "Por favor, preencha todos os campos.";
          loginStatus.style.color = "red";
          return;
        }

        loginStatus.textContent = "Fazendo login...";
        loginStatus.style.color = "black";

        try {
          const response = await fetch("/api/moloni-login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, password }),
          });

          if (!response.ok) {
            const raw = await response.text();
            console.error("Moloni login falhou:", response.status, raw);
            loginStatus.textContent = "Erro no login.";
            loginStatus.style.color = "red";
            return;
          }

          const data = await response.json();
          localStorage.setItem("refresh_token", data.refresh_token);
          localStorage.setItem("moloni_token", data.access_token);
          loginStatus.textContent = "Login efetuado com sucesso!";
          loginStatus.style.color = "green";
          document.getElementById("tokenDisplay").textContent =
            "Token armazenado: " + data.access_token.substring(0, 25) + "‚Ä¶";
        } catch (err) {
          console.error("Erro:", err.message);
          loginStatus.textContent = "Erro a processar resposta do servidor.";
          loginStatus.style.color = "red";
        }
      }
      let selectedTableIndex = null;
      function openModal(index) {
        selectedTableIndex = index;
        const modal = document.getElementById("invoiceModal");
        const textarea = document.getElementById("modalInvoiceNotes");

        textarea.value = ""; // limpa
        modal.style.display = "flex";
        textarea.focus();
      }
      function validarNif(nif) {
        return /^\d{9}$/.test(nif);
      }
      function closeModal() {
        document.getElementById("invoiceModal").style.display = "none";
      }

      const nifInput = document.getElementById("modalInvoiceNif");
      const invoiceTypeSelect = document.getElementById("modalInvoiceType");

      let userSelectedType = false;
      invoiceTypeSelect.addEventListener("change", () => {
        userSelectedType = true; // marca que o utilizador escolheu manualmente
      });
      nifInput.addEventListener("input", () => {
        const nif = nifInput.value.trim();
        const autoType = determineInvoiceType(0, nif);

        // s√≥ atualiza se o utilizador **n√£o** escolheu manualmente
        if (!userSelectedType) {
          invoiceTypeSelect.value = autoType;
        }
      });

      async function confirmEmitirFatura() {
        const notes = document.getElementById("modalInvoiceNotes").value.trim();
        let docType = document.getElementById("modalInvoiceType").value; // valor selecionado pelo usu√°rio
        const nif = document.getElementById("modalInvoiceNif").value.trim();

        if (nif && !validarNif(nif)) {
          alert("NIF inv√°lido. Deve ter 9 d√≠gitos num√©ricos.");
          return;
        }

        closeModal();

        // Se o utilizador n√£o escolheu manualmente, decide automaticamente
        if (!docType) {
          const table = tables[selectedTableIndex];
          let totalValue = 0;

          // Somar pre√ßo * quantidade de todos os produtos da mesa
          const orderSections = [
            "plates",
            "secondaryPlates",
            "sides",
            "extras",
            "desserts",
            "drinks",
            "coffee",
          ];
          orderSections.forEach((section) => {
            if (table.order[section]) {
              table.order[section].forEach((item) => {
                totalValue +=
                  (parseFloat(item.price) || 0) * (parseFloat(item.qty) || 1);
              });
            }
          });

          docType = determineInvoiceType(totalValue, nif); // chama a fun√ß√£o aqui
        }

        await emitirFatura(selectedTableIndex, notes, docType, nif);
      }

      function determineInvoiceType(totalValue, nif) {
        // Se NIF n√£o existe ou √© inv√°lido, usar FS
        if (!nif || !/^\d{9}$/.test(nif)) {
          return "FS";
        }

        // Se existe NIF e valor √© maior que 0, usar FT
        return "FT";
      }
      const tables = [];

      async function emitirFatura(index, notes = "", docType = "FR", nif = "") {
        const token = localStorage.getItem("moloni_token");
        if (!token) {
          alert("Por favor, fa√ßa login no Moloni primeiro!");
          return;
        }

        const table = tables[index];
        if (!table) {
          alert("Mesa inv√°lida!");
          return;
        }

        const products = convertOrderToMoloniProducts(table.order);
        if (!products || products.length === 0) {
          alert("N√£o h√° produtos selecionados para emitir a fatura.");
          return;
        }

        const productsForMoloni = products.map((p) => ({
          product_id: p.product_id,
          name: p.name,
          qty: parseFloat(p.qty) > 0 ? parseFloat(p.qty) : 1,
          price: parseFloat(p.price) || 0,
          summary: String(p.name || "Produto"),
          unit_id: p.unit_id,
          taxes:
            p.taxes && p.taxes.length
              ? p.taxes
              : [{ tax_id: 3630173, value: parseFloat(taxInfo?.valor ?? 23) }],
        }));

        const payload = {
          notes,
          tableName: table.name,
          products: productsForMoloni,
          document_type: docType,
          nif: nif || null,
        };
        console.log(nif);
        console.log(
          "Payload enviado ao backend:",
          JSON.stringify(payload, null, 2)
        );

        try {
          const response = await fetch("/api/emitir-fatura", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const text = await response.text();
            console.error("Erro do backend:", text);
            alert("Erro ao emitir fatura.");
            return;
          }

          const data = await response.json();
          console.log("Resposta da API emitir-fatura:", data);

          if (data.pdfUrl && typeof data.pdfUrl === "string") {
            window.open(data.pdfUrl, "_blank");
            imprimirFaturaLocal(table, data); // imprime localmente
          } else {
            console.error("PDF inv√°lido:", data.pdfUrl);
            alert("Erro: Fatura criada mas sem PDF.");
          }
        } catch (err) {
          console.error("Erro no pedido:", err);
          alert("Erro na comunica√ß√£o com o servidor.");
        }
      }
      async function emitirFaturaLocal(index) {
        const table = tables[index];
        if (!table) {
          alert("Mesa inv√°lida!");
          return;
        }

        // calcular totais
        let totalSemIVA = 0;
        let ivaRate = 0.23; // 23%
        table.order.forEach((item) => {
          totalSemIVA += item.qty * item.price;
        });
        const ivaValor = totalSemIVA * ivaRate;
        const totalComIVA = totalSemIVA + ivaValor;

        // === Gerar PDF ===
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFont("courier", "normal");
        doc.setFontSize(12);

        doc.text("FATURA SIMULADA", 14, 20);
        doc.text(`Mesa: ${table.name}`, 14, 30);
        doc.text("===================================", 14, 35);

        let y = 45;
        table.order.forEach((item) => {
          doc.text(
            `${item.name}  x${item.qty}  ${item.price.toFixed(2)}‚Ç¨`,
            14,
            y
          );
          y += 8;
        });

        doc.text("===================================", 14, y);
        y += 10;
        doc.text(`Total s/ IVA: ${totalSemIVA.toFixed(2)} ‚Ç¨`, 14, y);
        y += 8;
        doc.text(`IVA (23%): ${ivaValor.toFixed(2)} ‚Ç¨`, 14, y);
        y += 8;
        doc.text(`Total c/ IVA: ${totalComIVA.toFixed(2)} ‚Ç¨`, 14, y);
        y += 15;
        doc.text("Obrigado pela prefer√™ncia!", 14, y);

        // exporta PDF
        doc.save("fatura_teste.pdf");

        // tamb√©m abre numa nova janela para imprimir
        const pdfData = doc.output("bloburl");
        const win = window.open(pdfData, "_blank");
        win.print();
      }

      const moloniProductMap = {
        Bolo: {
          product_id: 210061572,
          price: 10,
          name: "bolo",
          tax_id: 3630173,
        },
        // adiciona mais produtos aqui conforme fores criando
      };
      // let tables = [];

      const openTablesDiv = document.getElementById("openTables");
      const closedTablesDiv = document.getElementById("closedTables");
      const orderDetails = document.getElementById("orderDetails");

      function renderTables() {
        openTablesDiv.innerHTML = "";
        closedTablesDiv.innerHTML = "";

        tables.forEach((table, index) => {
          const div = document.createElement("div");
          div.className = `table-item ${table.open ? "open" : "closed"}`;
          div.innerHTML = `
                                          <strong>${table.name}</strong> - ${
            table.open ? "Aberta" : "Fechada"
          }
                                          ${
                                            table.kitchenNote
                                              ? `<br><small><em>Nota: ${table.kitchenNote}</em></small>`
                                              : ""
                                          }
                                        `;
          div.onclick = () => renderOrderDetails(index);

          if (table.open) {
            openTablesDiv.appendChild(div);
          } else {
            closedTablesDiv.appendChild(div);
          }
        });
      }
      const categories = [
        "plates",
        "secondaryPlates",
        "sides",
        "extras",
        "desserts",
        "drinks",
        "coffee",
      ];

      function renderOrderDetails(index) {
        selectedTableIndex = index;
        const table = tables[index];
        const order = table.order;
        const prepared = table.prepared;

        /*  function renderSection(title, items, prepState, key) {
                                  if (!items || items.length === 0) return "";
                                  return `
                                          <div class="section">
                                            <h3>${title}</h3>
                                            ${items
                                              .map(
                                                (item, i) => `
                                              <div class="item">
                                                <input type="checkbox" ${prepState[i] ? "checked" : ""}
                                                  onchange="togglePrepared(${index}, '${key}', ${i})">
                                                <label>${item.name}</label>
                                              </div>
                                            `
                                              )
                                              .join("")}
                                          </div>
                                        `;
                                }
                           */

        // Fun√ß√£o para renderizar **uma tabela √∫nica** para todos os itens
        function renderAllItemsTable(order, prepared, index) {
          let rowsHtml = "";

          for (const key in order) {
            if (key === "status") continue;
            const items = order[key];
            const prepState = prepared[key] || [];
            const category = categoryTitles[key] || key;

            if (!items || items.length === 0) continue;

            items.forEach((item, i) => {
              rowsHtml += `
                    <tr>
                      <td style="border:1px solid #ccc; padding:5px;">${category}</td>
                      <td style="border:1px solid #ccc; padding:5px;">${
                        item.name
                      }</td>
                      <td style="border:1px solid #ccc; padding:5px; text-align:center;">${
                        item.quantity
                      }</td>
                      <td style="border:1px solid #ccc; padding:5px; text-align:center;">
                        <input type="checkbox" ${prepState[i] ? "checked" : ""}
                          onchange="togglePrepared(${index}, '${key}', ${i})">
                      </td>
                    </tr>
                  `;
            });
          }

          return `
                <div class="section" style="display:flex; justify-content:center; margin-top:10px;">
                  <table style="width:100%; max-width:600px; border-collapse: collapse; border:1px solid #ccc;">
                    <thead>
                      <tr style="background-color:#f2f2f2;">
                        <th style="border:1px solid #ccc; padding:5px; text-align:left;">Categoria</th>
                        <th style="border:1px solid #ccc; padding:5px; text-align:left;">Item</th>
                        <th style="border:1px solid #ccc; padding:5px; text-align:center;">Quantidade</th>
                        <th style="border:1px solid #ccc; padding:5px; text-align:center;">Preparado</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${rowsHtml}
                    </tbody>
                  </table>
                </div>
              `;
        }

        // Mapeia t√≠tulos bonitinhos para as categorias
        const categoryTitles = {
          plates: "Pratos",
          secondaryPlates: "Pratos Secund√°rios",
          sides: "Acompanhamentos",
          extras: "Extras",
          desserts: "Sobremesas",
          drinks: "Bebidas",
          coffee: "Caf√©s",
        };

        const sectionsHtml = renderAllItemsTable(order, prepared, index);

        orderDetails.innerHTML = `
                    <h2 style="margin-bottom: 1rem;">
                      ${table.name} - <span style="color: ${
          table.open ? "#28a745" : "#dc3545"
        };">
                        ${table.open ? "Aberta" : "Fechada"}
                      </span>
                    </h2>

                    <!-- Nota da Cozinha -->
                    <div class="section" style="margin-bottom: 20px;">
                      <label for="kitchenNote" style="font-weight:600; display:block;">Nota da Cozinha:</label>
                      <textarea id="kitchenNote" rows="3" style="width:100%; box-sizing:border-box; padding:8px; border-radius:6px; border:1px solid #ccc;">
                        ${table.kitchenNote}
                      </textarea>
                      <button class="btn btn-primary" onclick="saveKitchenNote(${index})" >Guardar Nota</button>
                    </div>

                    <!-- Status de Pagamento -->
                    <div class="section" style="margin-bottom:20px;">
                      <label style="font-weight:600; display:block;">Status do Pagamento:</label>
                      <div class="status ${
                        order.status === "paid" ? "paid" : "unpaid"
                      }"
                           style="margin-bottom:10px; padding:8px 12px; border-radius:6px; background-color:${
                             order.status === "paid" ? "#d4edda" : "#f8d7da"
                           }; color:${
          order.status === "paid" ? "#155724" : "#721c24"
        };">
                        ${order.status === "paid" ? "Pago" : "Por Pagar"}
                      </div>
                      <button class="btn btn-secondary" onclick="togglePaid(${index})">
                        Marcar como ${
                          order.status === "paid" ? "Por Pagar" : "Pago"
                        }
                      </button>
                    </div>

                    <!-- Bot√µes de a√ß√£o -->
                   <div class="section buttons" style="display:flex; gap:10px; margin-bottom:20px;">
              <button class="btn btn-secondary" style="background-color:red; color:#fff;" onclick="toggleOpenClose(${index})">
                ${table.open ? "Fechar Mesa" : "Abrir Mesa"}
              </button>
              <button class="btn btn-secondary" style="background-color:orange; color:black;" onclick="openEditTableModal(${index})">
                Alterar Artigos
              </button>
              <button class="btn btn-primary" style="background-color:#28a745; color:#fff;" onclick="openModal(${index})">
                Emitir Fatura
              </button>
               <button class="btn btn-secondary" style="background-color:black; color:#fff;" onclick="openCalculator(${index})">
          Calculadora
        </button>
            </div>

            <!-- Tabela de itens centralizada -->
            ${sectionsHtml}
                    </div>
                  `;
      }
      window.togglePrepared = function (tableIndex, section, itemIndex) {
        tables[tableIndex].prepared[section][itemIndex] =
          !tables[tableIndex].prepared[section][itemIndex];
        renderOrderDetails(tableIndex);
      };

      window.togglePaid = function (index) {
        const order = tables[index].order;
        order.status = order.status === "paid" ? "unpaid" : "paid";
        renderOrderDetails(index);
        renderTables();
      };

      window.toggleOpenClose = function (index) {
        tables[index].open = !tables[index].open;
        renderOrderDetails(index);
        renderTables();
      };

      window.saveKitchenNote = function (index) {
        const textarea = document.getElementById("kitchenNote");
        tables[index].kitchenNote = textarea.value.trim();
        renderTables();
      };

      function toggleLoginForm() {
        const form = document.getElementById("moloniLoginForm");
        form.style.display = form.style.display === "none" ? "block" : "none";
      }
      function closeCreateTableModal() {
        document.getElementById("createTableModal").style.display = "none";
      }
      /*  window.addEventListener("DOMContentLoaded", async () => { necess√°rio
              const tokenDisplayDiv = document.getElementById("tokenDisplay");

              // 1Ô∏è‚É£ Verifica se h√° erro ou code na URL (OAuth)
              const params = new URLSearchParams(window.location.search);
              const code = params.get("code");
              const error = params.get("error");

              if (code) {
                try {
                  await fetch("/api/moloni-exchange-code", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ code }),
                  });
                  history.replaceState({}, "", "/login.html"); // limpa URL
                } catch (err) {
                  console.error("Erro a obter tokens:", err);
                  alert("Erro no login com Moloni.");
                }
              }

              if (error) {
                alert(
                  "Erro durante o login com Moloni: " + decodeURIComponent(error)
                );
              }

              // 2Ô∏è‚É£ Verifica o status do token na sess√£o
              try {
                const res = await fetch("/api/moloni-token-status");
                const { valid } = await res.json();
                updateUI(valid);
              } catch (err) {
                console.error("Erro ao verificar status do token:", err);
                tokenDisplayDiv.textContent = "‚ùå Erro ao verificar autentica√ß√£o.";
              }
            });

            */

      window.addEventListener("DOMContentLoaded", async () => {
        // üî• Skip Moloni auth and force UI valid
        updateUI(true);
      });

      /* function updateUI(isValid) { necess√°rio
              const tokenDisplayDiv = document.getElementById("tokenDisplay");
              const mainContent = document.getElementById("mainContent");

              if (isValid) {
                tokenDisplayDiv.textContent = "‚úîÔ∏è Sistema pronto a usar";

                tokenDisplayDiv.className = "token-status ok";
                loginForm.style.display = "none"; // üî• esconde login
                document.querySelector("header").classList.remove("login-active");

                navLinks.style.display = "flex"; // üî• mostra navega√ß√£o
                mainContent.style.display = "block";
                document.querySelectorAll(".protected").forEach((el) => {
                  el.style.display = "inline-block";
                });
              } else {
                tokenDisplayDiv.textContent = "‚ö†Ô∏è Sistema n√£o autenticado";
                tokenDisplayDiv.className = "token-status error";
                document.querySelector("header").classList.add("login-active");
                loginForm.style.display = "flex"; // üî• mostra login

                navLinks.style.display = "none"; // üî• esconde navega√ß√£o
                mainContent.style.display = "none";
                document.querySelectorAll(".protected").forEach((el) => {
                  el.style.display = "none";
                });
                const modal = document.getElementById("createTableModal");
                if (modal) modal.style.display = "none";
              }
            }


            */

      function updateUI(isValid) {
        const tokenDisplayDiv = document.getElementById("tokenDisplay");
        const mainContent = document.getElementById("mainContent");

        // üî• Force always valid
        isValid = true;

        tokenDisplayDiv.textContent = "‚úîÔ∏è Sistema pronto a usar";
        tokenDisplayDiv.className = "token-status ok";

        loginForm.style.display = "none"; // esconde login
        document.querySelector("header").classList.remove("login-active");

        navLinks.style.display = "flex";
        mainContent.style.display = "block";
        document.querySelectorAll(".protected").forEach((el) => {
          el.style.display = "inline-block";
        });
      }
      function convertOrderToMoloniProducts(order) {
        const sections = [
          "plates",
          "secondaryPlates",
          "sides",
          "extras",
          "desserts",
          "drinks",
          "coffee",
        ];
        const products = [];

        sections.forEach((section) => {
          if (!order[section]) order[section] = [];

          order[section].forEach((item) => {
            // item j√° tem product_id, name, price, tax_id
            products.push({
              product_id: item.product_id,
              name: item.name,
              qty: item.qty || 1,
              unit_name: "Unidade",
              unit_short_name: "Un",
              price: item.price,
              taxes: [{ tax_id: item.tax_id }],
            });
          });
        });

        console.log("Produtos que v√£o para Moloni:", products);
        return products;
      }

      let moloniProducts = []; // global, para todas as fun√ß√µes

      async function openCreateTableModal() {
        const saveBtn = document.getElementById("saveTableBtn");
        saveBtn.textContent = "Abrir Mesa"; // ou "Criar Mesa"
        saveBtn.onclick = createNewTable; // fun√ß√£o de criar
        // Limpa os containers de bot√µes
        const containerIds = [
          "principalArticles",
          "secondaryArticles",
          "sideArticles",
          "dessertArticles",
          "drinkArticles",
          "extraArticles",
        ];
        containerIds.forEach((id) => {
          document.getElementById(id).innerHTML = "";
        });

        try {
          const response = await fetch("/artigo/artigos");
          //  if (!response.ok) throw new Error("Erro ao buscar artigos");

          const artigos = await response.json();
          console.log("Artigos carregados:", artigos); // üëà aqui sim j√° s√£o os dados

          moloniProducts = artigos; // guarda globalmente

          artigos.forEach((artigo) => {
            const categoria = (artigo.summary || "")
              .trim()
              .toLowerCase()
              .normalize("NFD")
              .replace(/[\u0300-\u036f]/g, "");

            let containerId;
            if (categoria === "prato principal")
              containerId = "principalArticles";
            else if (categoria === "prato secundario")
              containerId = "secondaryArticles";
            else if (categoria === "acompanhamento")
              containerId = "sideArticles";
            else if (categoria === "sobremesa") containerId = "dessertArticles";
            else if (categoria === "bebida") containerId = "drinkArticles";
            else if (categoria === "extra") containerId = "extraArticles";
            else return; // ignora categorias desconhecidas

            const container = document.getElementById(containerId);

            // Create container div for article + quantity controls
            const div = document.createElement("div");
            div.className = "article-item";

            // Article button
            const btn = document.createElement("button");
            btn.type = "button";
            btn.textContent = artigo.name;
            btn.className = "article-btn";
            btn.dataset.selected = "false";
            btn.classList.remove("selected");

            // üîπ guarda refer√™ncia do artigo
            btn.dataset.article = JSON.stringify(artigo);

            btn.onclick = () => {
              const selected = btn.dataset.selected === "true";
              btn.dataset.selected = selected ? "false" : "true";
              btn.classList.toggle("selected");
            };
            // antigo
            /* btn.onclick = () => {
                    btn.dataset.selected =
                      btn.dataset.selected === "true" ? "false" : "true";
                    btn.classList.toggle("selected");
                  };*/

            // Quantity container
            const qtyContainer = document.createElement("div");
            qtyContainer.className = "qty-container";
            qtyContainer.style.display = "inline-flex"; // mostra sempre

            // Minus button
            const minus = document.createElement("button");
            minus.type = "button";
            minus.textContent = "‚Äì";
            minus.className = "qty-btn";
            minus.onclick = () => {
              qtyInput.value = Math.max(1, parseInt(qtyInput.value) - 1);
            };

            // Quantity input
            const qtyInput = document.createElement("input");
            qtyInput.type = "number";
            qtyInput.min = 1;
            qtyInput.value = 1;
            qtyInput.style.width = "55px";
            qtyInput.style.textAlign = "center";

            // Plus button
            const plus = document.createElement("button");
            plus.type = "button";
            plus.textContent = "+";
            plus.className = "qty-btn";
            plus.onclick = () => {
              qtyInput.value = parseInt(qtyInput.value) + 1;
            };

            // Append controls
            qtyContainer.appendChild(minus);
            qtyContainer.appendChild(qtyInput);
            qtyContainer.appendChild(plus);

            // Add button + qty controls to div
            div.appendChild(btn);
            div.appendChild(qtyContainer);
            container.appendChild(div);
          });

          document.getElementById("newTableName").value = "";
          document.getElementById("createTableModal").style.display = "flex";
        } catch (err) {
          // alert("N√£o foi poss√≠vel carregar os artigos: " + err.message);
        }
      }
      function createNewTable() {
        const tableName = document.getElementById("newTableName").value.trim();
        if (!tableName) {
          alert("Insere um nome para a mesa!");
          return;
        }

        const plates = getSelectedProductsFromButtons("principalArticles");
        const secondaryPlates =
          getSelectedProductsFromButtons("secondaryArticles");
        const sides = getSelectedProductsFromButtons("sideArticles");
        const desserts = getSelectedProductsFromButtons("dessertArticles");
        const drinks = getSelectedProductsFromButtons("drinkArticles");
        const extras = getSelectedProductsFromButtons("extraArticles");

        // ‚ùå Valida√ß√£o: pelo menos um artigo deve ser selecionado
        if (
          plates.length === 0 &&
          secondaryPlates.length === 0 &&
          sides.length === 0 &&
          desserts.length === 0 &&
          drinks.length === 0 &&
          extras.length === 0
        ) {
          alert("Seleciona pelo menos um artigo para criar a mesa!");
          return;
        }

        const newTable = {
          id: tables.length + 1,
          name: tableName,
          open: true,
          kitchenNote: "",
          order: {
            status: "unpaid",
            plates,
            secondaryPlates,
            sides,
            desserts,
            drinks,
            extras,
            coffee: [],
          },
          prepared: {
            plates: Array(plates.length).fill(false),
            secondaryPlates: Array(secondaryPlates.length).fill(false),
            sides: Array(sides.length).fill(false),
            desserts: Array(desserts.length).fill(false),
            drinks: Array(drinks.length).fill(false),
            extras: Array(extras.length).fill(false),
            coffee: [],
          },
        };

        tables.push(newTable);
        renderTables();
        document.getElementById("createTableModal").style.display = "none";
      }
      function renderArticleButtons(containerId, articles) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        articles.forEach((article) => {
          const div = document.createElement("div");
          div.className = "article-item";

          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = article.name;
          btn.className = "article-btn";
          btn.dataset.selected = "false";

          const qtyInput = document.createElement("input");
          qtyInput.type = "number";
          qtyInput.min = 1;
          qtyInput.value = 1;
          qtyInput.style.width = "50px";
          qtyInput.style.marginLeft = "10px";

          btn.onclick = () => {
            const selected = btn.dataset.selected === "true";
            btn.dataset.selected = selected ? "false" : "true";
            btn.classList.toggle("selected");
          };

          div.appendChild(btn);
          div.appendChild(qtyInput);
          container.appendChild(div);

          // Guardar refer√™ncia do artigo com quantidade
          btn.dataset.article = JSON.stringify(article);
        });
      }
      function getSelectedProductsFromButtons(containerId) {
        return Array.from(
          document.querySelectorAll(`#${containerId} .article-btn.selected`)
        )
          .map((btn) => {
            if (!btn.dataset.article) return null;
            const article = JSON.parse(btn.dataset.article);

            // Pega o input dentro do mesmo .article-item
            const qtyInput = btn
              .closest(".article-item")
              .querySelector("input[type='number']");
            const qty = parseInt(qtyInput?.value) || 1;

            return { ...article, quantity: qty };
          })
          .filter(Boolean);
      }
      /*
            function getSelectedProductsFromButtons(containerId) { antigo necess√°rio talvez quando for a s√©rio
              return Array.from(
                document.querySelectorAll(`#${containerId} .article-btn.selected`)
              )
                .map((btn) => {
                  if (!btn.dataset.article) return null; // ignora se n√£o houver artigo
                  const article = JSON.parse(btn.dataset.article);
                  const qty = parseInt(btn.nextSibling.value) || 1;
                  return { ...article, quantity: qty };
                })
                .filter((item) => item !== null); // remove os nulos
            }
      */
      window.addEventListener("DOMContentLoaded", () => {
        const btn = document.querySelector(".btn");
        if (btn) btn.addEventListener("click", openCreateTableModal);
      });

      function openEditTableModal(tableIndex) {
        const table = tables[tableIndex];

        // Limpa os containers de artigos
        const containerIds = [
          "principalArticles",
          "secondaryArticles",
          "sideArticles",
          "dessertArticles",
          "drinkArticles",
          "extraArticles",
        ];
        containerIds.forEach((id) => {
          document.getElementById(id).innerHTML = "";
        });

        // Atualiza bot√£o de salvar
        const saveBtn = document.getElementById("saveTableBtn");
        saveBtn.textContent = "Atualizar Mesa";
        saveBtn.onclick = () => updateTable(tableIndex);

        // Mapeamento container ‚Üí key da ordem
        const containerToKey = {
          principalArticles: "plates",
          secondaryArticles: "secondaryPlates",
          sideArticles: "sides",
          dessertArticles: "desserts",
          drinkArticles: "drinks",
          extraArticles: "extras",
        };

        // Renderiza artigos
        moloniProducts.forEach((artigo) => {
          const categoria = (artigo.summary || "")
            .trim()
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");

          let containerId;
          if (categoria === "prato principal")
            containerId = "principalArticles";
          else if (categoria === "prato secundario")
            containerId = "secondaryArticles";
          else if (categoria === "acompanhamento") containerId = "sideArticles";
          else if (categoria === "sobremesa") containerId = "dessertArticles";
          else if (categoria === "bebida") containerId = "drinkArticles";
          else if (categoria === "extra") containerId = "extraArticles";
          else return;

          const container = document.getElementById(containerId);
          const div = document.createElement("div");
          div.className = "article-item";

          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = artigo.name;
          btn.className = "article-btn";
          btn.dataset.article = JSON.stringify(artigo);

          // Verifica se o artigo j√° est√° selecionado na mesa
          const key = containerToKey[containerId];
          const currentItems = table.order[key] || [];
          const selectedItem = currentItems.find(
            (i) => i.product_id === artigo.product_id
          );

          if (selectedItem) {
            btn.dataset.selected = "true";
            btn.classList.add("selected");
          } else {
            btn.dataset.selected = "false";
            btn.classList.remove("selected");
          }

          btn.onclick = () => {
            btn.dataset.selected =
              btn.dataset.selected === "true" ? "false" : "true";
            btn.classList.toggle("selected");
          };

          const qtyInput = document.createElement("input");
          qtyInput.type = "number";
          qtyInput.min = 1;
          qtyInput.value = selectedItem ? selectedItem.quantity : 1;
          qtyInput.style.width = "50px";
          qtyInput.style.marginLeft = "10px";

          div.appendChild(btn);
          div.appendChild(qtyInput);
          container.appendChild(div);
        });

        // Preenche o nome da mesa
        document.getElementById("newTableName").value = table.name;

        // Mostra modal
        document.getElementById("createTableModal").style.display = "flex";
      }

      function updateTable(tableIndex) {
        const table = tables[tableIndex];

        const containerToKey = {
          principalArticles: "plates",
          secondaryArticles: "secondaryPlates",
          sideArticles: "sides",
          dessertArticles: "desserts",
          drinkArticles: "drinks",
          extraArticles: "extras",
        };

        Object.keys(containerToKey).forEach((containerId) => {
          table.order[containerToKey[containerId]] =
            getSelectedProductsFromButtons(containerId);
        });

        // Atualiza a interface
        renderTables();
        document.getElementById("createTableModal").style.display = "none";
      }
    </script>

    <script>
      const form = document.getElementById("loginForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const tokenDisplayDiv = document.getElementById("tokenDisplay");
        const formData = new FormData(form);
        const username = formData.get("username");
        const password = formData.get("password");

        try {
          const resp = await fetch("/api/login-moloni", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          const result = await resp.json();

          if (resp.ok) {
            const statusResp = await fetch("/api/moloni-token-status");
            const { valid } = await statusResp.json();
            updateUI(valid);
            tokenDisplayDiv.textContent = valid
              ? "‚úîÔ∏è Sistema pronto a usar"
              : "‚ö†Ô∏è Sistema n√£o autenticado";
          } else {
            alert(
              "‚ùå Erro: " + (result.detail?.error_description || result.error)
            );
          }
        } catch (err) {
          console.error("Erro de conex√£o:", err);
          alert("Erro ao conectar com o servidor.");
        }
      });
      function openCalculator(index) {
        const table = tables[index];
        const order = table.order;

        // Calcular total
        let total = 0;
        for (const key in order) {
          if (key === "status") continue;
          order[key].forEach((item) => {
            total += item.price * (item.quantity || 1);
          });
        }

        // Criar modal/overlay mais estilizado
        const modalHtml = `
    <div id="calculatorModal" style="
        position:fixed;
        top:0; left:0; right:0; bottom:0;
        background: rgba(0,0,0,0.6);
        display:flex;
        justify-content:center;
        align-items:center;
        z-index:1000;
    ">
      <div style="
          background:#fff;
          padding:30px;
          border-radius:12px;
          width:350px;
          text-align:center;
          font-family: Arial, sans-serif;
          box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      ">
        <h2 style="margin-bottom:20px; font-size:1.5em;">Calculadora da Mesa</h2>
        <p style="margin-bottom:20px; font-size:1.2em;">Total: <strong>‚Ç¨${total.toFixed(
          2
        )}</strong></p>

        <label for="amountGiven" style="font-size:1.1em; display:block; margin-bottom:8px;">Valor entregue pelo cliente:</label>
        <input type="number" id="amountGiven" style="
            width:100%; 
            padding:12px; 
            font-size:1.2em; 
            margin-bottom:20px; 
            border: 1px solid #ccc; 
            border-radius:6px;
        " />

        <p id="changeOutput" style="font-size:1.2em; margin-bottom:20px;"></p>

        <div style="display:flex; justify-content:space-between; gap:10px;">
          <button class="btn btn-primary" onclick="calculateChange(${total})" style="
              flex:1;
              padding:12px 0; 
              font-size:1.1em; 
              border-radius:6px;
          ">Calcular Troco</button>
          <button class="btn btn-secondary" onclick="closeCalculator()" style="
              flex:1;
              padding:12px 0; 
              font-size:1.1em; 
              border-radius:6px;
          ">Fechar</button>
        </div>
      </div>
    </div>
  `;

        // Inserir modal no body
        document.body.insertAdjacentHTML("beforeend", modalHtml);
      }

      function calculateChange(total) {
        const amountGiven =
          parseFloat(document.getElementById("amountGiven").value) || 0;
        const change = amountGiven - total;
        const output = document.getElementById("changeOutput");
        if (change < 0) {
          output.textContent = `Cliente entregou menos que o total! Faltam ‚Ç¨${Math.abs(
            change
          ).toFixed(2)}`;
          output.style.color = "red";
        } else {
          output.textContent = `Troco: ‚Ç¨${change.toFixed(2)}`;
          output.style.color = "green";
        }
      }
      function closeCalculator() {
        const modal = document.getElementById("calculatorModal");
        if (modal) modal.remove();
      }
    </script>
  </body>
</html>
