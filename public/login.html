<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Painel de Admin / Recess√£o</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #f2f2f2;
      }
      header {
        background: #fff;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
        flex-wrap: wrap;
        gap: 1rem;
      }
      header h1 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 600;
        flex-grow: 1;
        min-width: 200px;
      }

      .logo-title {
        display: flex;
        align-items: center;
        gap: 0.6rem;
      }

      .logo {
        height: 40px;
        width: auto;
      }
      .system-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
      }
      header .links-container {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 1rem;
      }

      header .links-container a {
        color: #007bff;
        text-decoration: none;
        font-weight: 600;
      }

      header .links-container a:hover {
        color: #0056b3;
      }
      .page-title {
        font-size: 1.6rem;
        font-weight: bold;
        margin: 20px 30px 10px;
        color: #333;
      }
      #tokenDisplay {
        color: #555;
        font-size: 0.9rem;
        margin: 10px 20px;
        text-align: right;
      }
      .login-section {
        background: #fff;
        padding: 15px;
        margin: 10px auto;
        width: 300px;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      }
      .login-section input {
        width: 100%;
        padding: 8px;
        margin: 6px 0;
        box-sizing: border-box;
      }
      .btn {
        padding: 6px 12px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
      }
      .btn:hover {
        background: #0056b3;
      }
      .container {
        display: flex;
        padding: 20px;
      }
      .table-lists {
        width: 30%;
        padding-right: 20px;
      }
      .table-section {
        margin-bottom: 30px;
      }
      .table-section h3 {
        margin-bottom: 10px;
        color: #333;
      }
      .table-item {
        background: white;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 8px;
        cursor: pointer;
      }
      .table-item.open {
        border-left: 5px solid green;
      }
      .table-item.closed {
        border-left: 5px solid red;
      }
      .order-details {
        flex-grow: 1;
        padding-left: 20px;
      }
      .section {
        background: white;
        margin-bottom: 20px;
        padding: 10px;
        border: 1px solid #ccc;
      }
      .section h3 {
        margin-top: 0;
      }
      .item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }
      .item input {
        margin-right: 10px;
      }
      .status {
        font-size: 0.9em;
        padding: 5px 10px;
        margin-bottom: 10px;
        display: inline-block;
        border-radius: 4px;
      }
      .status.paid {
        background: #d4edda;
        color: #155724;
      }
      .status.unpaid {
        background: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>

  <body>
    <header>
      <div class="links-container">
        <div class="logo-title">
          <img src="/logo.png" alt="Logo" class="logo" />
        </div>
        <a
          href="https://api.moloni.pt/v1/authorize/?response_type=code&client_id=249928302_testes_api&redirect_uri=https://restuante-cozinha.onrender.com/callback"
        >
          Login com Moloni
        </a>
        <a href="/faturas.html">üìÑ Ver Faturas</a>
      </div>
      <div id="tokenDisplay"></div>
      <!-- Login antigo via username/password (comentado) 
      <div id="moloniLoginForm" style="margin-top: 15px">
        <input id="username" type="email" placeholder="Email Moloni" />
        <input id="password" type="password" placeholder="Password Moloni" />
        <button onclick="loginMoloni()">Login</button>
        <p id="loginStatus"></p>
      </div>
        -->
    </header>
    <h1>Painel de Admin / Recess√£o</h1>
    <div class="container">
      <div class="table-lists">
        <div class="table-section">
          <h3>Mesas Abertas</h3>
          <div id="openTables"></div>
        </div>

        <div class="table-section">
          <h3>Mesas Fechadas</h3>
          <div id="closedTables"></div>
        </div>
      </div>

      <div class="order-details" id="orderDetails">
        <p>Selecione uma mesa para ver os detalhes do pedido</p>
      </div>
    </div>

    <div
      id="invoiceModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      "
    >
      <div
        style="
          background: white;
          padding: 20px;
          border-radius: 5px;
          width: 300px;
          box-sizing: border-box;
        "
      >
        <h3>Notas para a Fatura</h3>
        <textarea
          id="modalInvoiceNotes"
          rows="6"
          style="width: 100%"
        ></textarea>
        <div style="margin-top: 15px; text-align: right">
          <button onclick="closeModal()" style="margin-right: 10px">
            Cancelar
          </button>
          <button onclick="confirmEmitirFatura()">Confirmar</button>
        </div>
      </div>
    </div>

    <script>
      async function parseJsonOrThrow(response) {
        const text = await response.text();
        try {
          return JSON.parse(text);
        } catch (e) {
          throw new Error(
            `Resposta n√£o-JSON (${response.status} ${
              response.statusText
            }): ${text.slice(0, 300)}`
          );
        }
      }
      async function loginMoloni() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const loginStatus = document.getElementById("loginStatus");

        if (!username || !password) {
          loginStatus.textContent = "Por favor, preencha todos os campos.";
          loginStatus.style.color = "red";
          return;
        }

        loginStatus.textContent = "Fazendo login...";
        loginStatus.style.color = "black";

        try {
          const response = await fetch("/api/moloni-login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, password }),
          });

          if (!response.ok) {
            const raw = await response.text();
            console.error("Moloni login falhou:", response.status, raw);
            loginStatus.textContent = "Erro no login.";
            loginStatus.style.color = "red";
            return;
          }

          const data = await response.json();
          localStorage.setItem("refresh_token", data.refresh_token);
          localStorage.setItem("moloni_token", data.access_token);
          loginStatus.textContent = "Login efetuado com sucesso!";
          loginStatus.style.color = "green";
          document.getElementById("tokenDisplay").textContent =
            "Token armazenado: " + data.access_token.substring(0, 25) + "‚Ä¶";
        } catch (err) {
          console.error("Erro:", err.message);
          loginStatus.textContent = "Erro a processar resposta do servidor.";
          loginStatus.style.color = "red";
        }
      }
      let selectedTableIndex = null;
      let currentTableIndex = null;
      function openModal(index) {
        // Aqui podes setar currentTableIndex consoante a mesa selecionada ‚Äî
        // ou adapta para receber o index.
        currentTableIndex = index; // exemplo fixo, muda conforme a tua l√≥gica
        const textarea = document.getElementById("modalInvoiceNotes");
        textarea.value = "";
        document.getElementById("invoiceModal").style.display = "flex";
        textarea.focus();
        document.getElementById("modalInvoiceNotes").value = ""; // limpa
        document.getElementById("invoiceModal").style.display = "flex";
      }

      function closeModal() {
        document.getElementById("invoiceModal").style.display = "none";
      }

      async function confirmEmitirFatura() {
        const notes = document.getElementById("modalInvoiceNotes").value.trim();

        closeModal();

        // Chama a fun√ß√£o que emite a fatura passando as notas
        await emitirFatura(currentTableIndex, notes);
      }

      async function emitirFatura(index, notes = "") {
        const token = localStorage.getItem("moloni_token");
        if (!token) {
          alert("Por favor, fa√ßa login no Moloni primeiro!");
          return;
        }

        const table = tables[index];
        if (!table) {
          alert("Mesa inv√°lida!");
          return;
        }

        const products = convertOrderToMoloniProducts(table.order);

        try {
          const response = await fetch("/api/emitir-fatura", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({
              tableName: table.name,
              notes: notes,
              order: table.order,
            }),
          });

          const data = await response.json();
          if (data.pdfUrl) {
            window.open(data.pdfUrl, "_blank");
          } else {
            alert("Erro: Fatura criada mas sem PDF.");
          }
        } catch (err) {
          console.error("Erro no pedido:", err);
          alert("Erro na comunica√ß√£o com o servidor.");
        }
      }
      const moloniProductMap = {
        Bolo: {
          product_id: 210061572,
          price: 10,
          tax_id: 3630173,
        },
        // adiciona mais produtos aqui conforme fores criando
      };
      const tables = [
        {
          id: 1,
          name: "Mesa 1",
          open: true,
          kitchenNote: "S√≥ tem Bolo na sobremesa",
          order: {
            status: "unpaid",
            plates: [], // no plates
            extras: [], // no extras
            drinks: [], // no drinks
            desserts: ["Bolo"], // only Bolo
            coffee: [], // no coffee
          },
          prepared: {
            plates: [],
            extras: [],
            drinks: [],
            desserts: [false], // Bolo not prepared yet
            coffee: [],
          },
        },
      ];

      const openTablesDiv = document.getElementById("openTables");
      const closedTablesDiv = document.getElementById("closedTables");
      const orderDetails = document.getElementById("orderDetails");

      function renderTables() {
        openTablesDiv.innerHTML = "";
        closedTablesDiv.innerHTML = "";

        tables.forEach((table, index) => {
          const div = document.createElement("div");
          div.className = `table-item ${table.open ? "open" : "closed"}`;
          div.innerHTML = `
                    <strong>${table.name}</strong> - ${
            table.open ? "Aberta" : "Fechada"
          }
                    ${
                      table.kitchenNote
                        ? `<br><small><em>Nota: ${table.kitchenNote}</em></small>`
                        : ""
                    }
                  `;

          div.onclick = () => renderOrderDetails(index);

          if (table.open) {
            openTablesDiv.appendChild(div);
          } else {
            closedTablesDiv.appendChild(div);
          }
        });
      }

      function renderOrderDetails(index) {
        selectedTableIndex = index;
        const table = tables[index];
        const order = table.order;
        const prepared = table.prepared;

        function renderSection(title, items, prepState, key) {
          if (items.length === 0) return "";
          return `
                    <div class="section">
                      <h3>${title}</h3>
                      ${items
                        .map(
                          (item, i) => `
                        <div class="item">
                          <input type="checkbox" ${
                            prepState[i] ? "checked" : ""
                          }
                            onchange="togglePrepared(${index}, '${key}', ${i})">
                          <label>${item}</label>
                        </div>
                      `
                        )
                        .join("")}
                    </div>
                  `;
        }

        orderDetails.innerHTML = `
                  <h2>${table.name} - ${table.open ? "Aberta" : "Fechada"}</h2>

                  <div class="section">
                    <label><strong>Nota da cozinha :</strong></label><br>
                    <textarea id="kitchenNote" rows="3" style="width:100%;box-sizing:border-box;">${
                      table.kitchenNote
                    }</textarea>
                    <button class="btn" onclick="saveKitchenNote(${index})" style="margin-top:5px;">Guardar Nota</button>
                  </div>

                  <div class="status ${
                    order.status === "paid" ? "paid" : "unpaid"
                  }">
                    ${order.status === "paid" ? "Pago" : "Por Pagar"}
                  </div>
                  <button class="btn" onclick="togglePaid(${index})">
                    Marcar como ${
                      order.status === "paid" ? "Por Pagar" : "Pago"
                    }
                  </button>

                  <button class="btn" style="margin-left:10px;" onclick="toggleOpenClose(${index})">
                    ${table.open ? "Fechar Mesa" : "Abrir Mesa"}
                  </button>
      <button class="btn" onclick="openModal(selectedTableIndex)">Emitir Fatura</button>
                  ${renderSection(
                    "Pratos",
                    order.plates,
                    prepared.plates,
                    "plates"
                  )}
                  ${renderSection(
                    "Extras",
                    order.extras,
                    prepared.extras,
                    "extras"
                  )}
                  ${renderSection(
                    "Bebidas",
                    order.drinks,
                    prepared.drinks,
                    "drinks"
                  )}
                  ${renderSection(
                    "Sobremesas",
                    order.desserts,
                    prepared.desserts,
                    "desserts"
                  )}
                  ${renderSection(
                    "Caf√©s",
                    order.coffee,
                    prepared.coffee,
                    "coffee"
                  )}
                `;
      }

      window.togglePrepared = function (tableIndex, section, itemIndex) {
        tables[tableIndex].prepared[section][itemIndex] =
          !tables[tableIndex].prepared[section][itemIndex];
        renderOrderDetails(tableIndex);
      };

      window.togglePaid = function (index) {
        const order = tables[index].order;
        order.status = order.status === "paid" ? "unpaid" : "paid";
        renderOrderDetails(index);
        renderTables();
      };

      window.toggleOpenClose = function (index) {
        tables[index].open = !tables[index].open;
        renderOrderDetails(index);
        renderTables();
      };

      window.saveKitchenNote = function (index) {
        const textarea = document.getElementById("kitchenNote");
        tables[index].kitchenNote = textarea.value.trim();
        renderTables();
      };
      function toggleLoginForm() {
        const form = document.getElementById("moloniLoginForm");
        form.style.display = form.style.display === "none" ? "block" : "none";
      }

      window.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        const error = params.get("error");
        const tokenDisplayDiv = document.getElementById("tokenDisplay");

        console.log("Code da URL:", code);

        if (code) {
          try {
            const res = await fetch("/api/moloni-exchange-code", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ code }),
            });

            const { access_token, refresh_token } = await res.json();
            console.log("Tokens recebidos:", access_token, refresh_token);

            // Apenas para debug (n√£o obrigat√≥rio)
            // localStorage.setItem("moloni_token", access_token);
            //localStorage.setItem("refresh_token", refresh_token);

            alert("Tokens armazenados com sucesso!");
            history.replaceState({}, "", "/login.html");
          } catch (err) {
            console.error("Erro a obter tokens:", err);
            alert("Erro no login com Moloni.");
          }
        }

        try {
          const res = await fetch("/api/moloni-token-status");
          const { valid } = await res.json();
          tokenDisplayDiv.textContent = valid
            ? "‚úîÔ∏è Sistema pronto a usar"
            : "‚ö†Ô∏è Sistema n√£o autenticado";
        } catch (err) {
          console.error("Erro ao verificar status do token:", err);
          tokenDisplayDiv.textContent = "‚ùå Erro ao verificar autentica√ß√£o.";
        }

        if (error) {
          alert(
            "Erro durante o login com Moloni: " + decodeURIComponent(error)
          );
          tokenDisplayDiv.textContent = "‚ö†Ô∏è Erro no login com Moloni.";
        }

        // Renderiza√ß√£o das mesas, se existir
        if (typeof renderTables === "function") {
          renderTables();
        }
      });

      function convertOrderToMoloniProducts(order) {
        const sections = ["plates", "extras", "drinks", "desserts", "coffee"];
        const products = [];

        sections.forEach((section) => {
          order[section].forEach((itemName) => {
            const product = moloniProductMap[itemName];
            if (product) {
              products.push({
                product_id: product.product_id,
                name: itemName,
                qty: 1,
                price: product.price,
                taxes: [
                  {
                    tax_id: product.tax_id,
                  },
                ],
              });
            } else {
              // Simply skip products not in moloniProductMap
              // You can remove this console.warn if you don't want logs
              // console.warn(`Produto "${itemName}" n√£o existe no cat√°logo Moloni.`);
            }
          });
        });

        return products;
      }
    </script>
  </body>
</html>
