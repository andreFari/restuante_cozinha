<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Painel de Admin / Recess√£o</title>
    <link rel="stylesheet" href="css/login.css" />
    <link rel="stylesheet" href="css/header.css" />
  </head>

  <body>
    <header>
      <div class="logo-title">
        <img src="" alt="Logo" class="logo" />
      </div>

      <div class="links-container">
        <a
          id="moloniLoginLink"
          href="https://api.moloni.pt/v1/authorize/?response_type=code&client_id=249928302_testes_api&redirect_uri=https://restuante-cozinha.onrender.com/callback"
          >‚èª Login com Moloni
        </a>
        <a href="./faturas.html" class="protected">üìÑ Ver Faturas</a>
        <a href="./guiasTransporte.html" class="protected"
          >üöö Guias de Transporte
        </a>

        <a href="./artigos.html" class="protected">üçΩÔ∏è Gerir Pratos</a>
      </div>

      <div id="tokenDisplay">‚ö†Ô∏è Sistema n√£o autenticado</div>
    </header>
    <div id="mainContent" style="display: none">
      <h1>Painel de Admin / Recess√£o</h1>
      <button class="btn protected">
        <!-- <button class="btn protected" onclick="openCreateTableModal()">-->
        Abrir Nova Mesa
      </button>

      <div class="container">
        <div class="table-lists">
          <div class="table-section">
            <h3>Mesas Abertas</h3>
            <div id="openTables"></div>
          </div>

          <div class="table-section">
            <h3>Mesas Fechadas</h3>
            <div id="closedTables"></div>
          </div>
        </div>

        <div class="order-details" id="orderDetails">
          <p>Selecione uma mesa para ver os detalhes do pedido</p>
        </div>
      </div>
      <div id="createTableModal" class="modal">
        <div class="modal-content">
          <!-- Left Column: Categories -->
          <div class="modal-left">
            <h3>Abrir Nova Mesa</h3>

            <div class="category-section">
              <h4>Pratos Principais</h4>
              <div id="principalArticles" class="article-list"></div>
            </div>

            <div class="category-section">
              <h4>Pratos Secund√°rios</h4>
              <div id="secondaryArticles" class="article-list"></div>
            </div>

            <div class="category-section">
              <h4>Acompanhamentos</h4>
              <div id="sideArticles" class="article-list"></div>
            </div>

            <div class="category-section">
              <h4>Sobremesas</h4>
              <div id="dessertArticles" class="article-list"></div>
            </div>

            <div class="category-section">
              <h4>Bebidas</h4>
              <div id="drinkArticles" class="article-list"></div>
            </div>

            <div class="category-section">
              <h4>Extras</h4>
              <div id="extraArticles" class="article-list"></div>
            </div>
          </div>

          <!-- Right Column: Table Info -->
          <div class="modal-right">
            <label for="newTableName">Nome da Mesa:</label>
            <input type="text" id="newTableName" placeholder="Ex: Mesa 3" />

            <div class="modal-actions">
              <button
                class="btn btn-secondary"
                onclick="closeCreateTableModal()"
              >
                Cancelar
              </button>
              <button class="btn btn-primary" onclick="createNewTable()">
                Abrir Mesa
              </button>
            </div>
          </div>
        </div>
      </div>
      <div id="invoiceModal" class="modal">
        <div class="modal-content">
          <div class="modal-right">
            <h3>Emitir Documento</h3>

            <label for="modalInvoiceType">Tipo:</label>
            <select
              id="modalInvoiceType"
              style="width: 100%; margin-bottom: 10px"
            >
              <option value="FR">Fatura/Recibo</option>
              <option value="FS">Fatura Simplificada</option>
              <option value="FT">Fatura</option>
            </select>

            <label for="modalInvoiceNif">NIF (opcional):</label>
            <input
              type="text"
              id="modalInvoiceNif"
              placeholder="999999990"
              style="width: 100%; margin-bottom: 10px"
            />

            <label for="modalInvoiceNotes">Notas:</label>
            <textarea
              id="modalInvoiceNotes"
              rows="4"
              style="width: 100%"
            ></textarea>

            <div class="modal-actions">
              <button onclick="closeModal()">Cancelar</button>
              <button onclick="confirmEmitirFatura()">Confirmar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      async function parseJsonOrThrow(response) {
        const text = await response.text();
        try {
          return JSON.parse(text);
        } catch (e) {
          throw new Error(
            `Resposta n√£o-JSON (${response.status} ${
              response.statusText
            }): ${text.slice(0, 300)}`
          );
        }
      }
      async function loginMoloni() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const loginStatus = document.getElementById("loginStatus");

        if (!username || !password) {
          loginStatus.textContent = "Por favor, preencha todos os campos.";
          loginStatus.style.color = "red";
          return;
        }

        loginStatus.textContent = "Fazendo login...";
        loginStatus.style.color = "black";

        try {
          const response = await fetch("/api/moloni-login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, password }),
          });

          if (!response.ok) {
            const raw = await response.text();
            console.error("Moloni login falhou:", response.status, raw);
            loginStatus.textContent = "Erro no login.";
            loginStatus.style.color = "red";
            return;
          }

          const data = await response.json();
          localStorage.setItem("refresh_token", data.refresh_token);
          localStorage.setItem("moloni_token", data.access_token);
          loginStatus.textContent = "Login efetuado com sucesso!";
          loginStatus.style.color = "green";
          document.getElementById("tokenDisplay").textContent =
            "Token armazenado: " + data.access_token.substring(0, 25) + "‚Ä¶";
        } catch (err) {
          console.error("Erro:", err.message);
          loginStatus.textContent = "Erro a processar resposta do servidor.";
          loginStatus.style.color = "red";
        }
      }
      let selectedTableIndex = null;
      function openModal(index) {
        selectedTableIndex = index;
        const modal = document.getElementById("invoiceModal");
        const textarea = document.getElementById("modalInvoiceNotes");

        textarea.value = ""; // limpa
        modal.style.display = "flex";
        textarea.focus();
      }
      function validarNif(nif) {
        return /^\d{9}$/.test(nif);
      }
      function closeModal() {
        document.getElementById("invoiceModal").style.display = "none";
      }

      async function confirmEmitirFatura() {
        const notes = document.getElementById("modalInvoiceNotes").value.trim();
        const docType = document.getElementById("modalInvoiceType").value;
        const nif = document.getElementById("modalInvoiceNif").value.trim();
        if (nif && !validarNif(nif)) {
          alert("NIF inv√°lido. Deve ter 9 d√≠gitos num√©ricos.");
          return;
        }
        closeModal();

        await emitirFatura(selectedTableIndex, notes, docType, nif);
      }

      async function emitirFatura(index, notes = "", docType = "FR", nif = "") {
        const token = localStorage.getItem("moloni_token");
        if (!token) {
          alert("Por favor, fa√ßa login no Moloni primeiro!");
          return;
        }

        const table = tables[index];
        if (!table) {
          alert("Mesa inv√°lida!");
          return;
        }

        const products = convertOrderToMoloniProducts(table.order);
        if (!products || products.length === 0) {
          alert("N√£o h√° produtos selecionados para emitir a fatura.");
          return;
        }

        const productsForMoloni = products.map((p) => ({
          product_id: p.product_id,
          name: p.name,
          qty: parseFloat(p.qty) > 0 ? parseFloat(p.qty) : 1,
          price: parseFloat(p.price) || 0,
          summary: String(p.name || "Produto"),
          unit_id: p.unit_id,
          taxes:
            p.taxes && p.taxes.length
              ? p.taxes
              : [{ tax_id: 3630173, value: parseFloat(taxInfo?.valor ?? 23) }],
        }));

        const payload = {
          notes,
          tableName: table.name,
          products: productsForMoloni,
          document_type: docType,
          nif: nif || null,
        };

        console.log(
          "Payload enviado ao backend:",
          JSON.stringify(payload, null, 2)
        );

        try {
          const response = await fetch("/api/emitir-fatura", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const text = await response.text();
            console.error("Erro do backend:", text);
            alert("Erro ao emitir fatura.");
            return;
          }

          const data = await response.json();
          console.log("Resposta da API emitir-fatura:", data);

          if (data.pdfUrl && typeof data.pdfUrl === "string") {
            window.open(data.pdfUrl, "_blank");
          } else {
            console.error("PDF inv√°lido:", data.pdfUrl);
            alert("Erro: Fatura criada mas sem PDF.");
          }
        } catch (err) {
          console.error("Erro no pedido:", err);
          alert("Erro na comunica√ß√£o com o servidor.");
        }
      }

      const moloniProductMap = {
        Bolo: {
          product_id: 210061572,
          price: 10,
          name: "bolo",
          tax_id: 3630173,
        },
        // adiciona mais produtos aqui conforme fores criando
      };
      let tables = [];

      const openTablesDiv = document.getElementById("openTables");
      const closedTablesDiv = document.getElementById("closedTables");
      const orderDetails = document.getElementById("orderDetails");

      function renderTables() {
        openTablesDiv.innerHTML = "";
        closedTablesDiv.innerHTML = "";

        tables.forEach((table, index) => {
          const div = document.createElement("div");
          div.className = `table-item ${table.open ? "open" : "closed"}`;
          div.innerHTML = `
                  <strong>${table.name}</strong> - ${
            table.open ? "Aberta" : "Fechada"
          }
                  ${
                    table.kitchenNote
                      ? `<br><small><em>Nota: ${table.kitchenNote}</em></small>`
                      : ""
                  }
                `;
          div.onclick = () => renderOrderDetails(index);

          if (table.open) {
            openTablesDiv.appendChild(div);
          } else {
            closedTablesDiv.appendChild(div);
          }
        });
      }
      const categories = [
        "plates",
        "secondaryPlates",
        "sides",
        "extras",
        "desserts",
        "drinks",
        "coffee",
      ];

      function renderOrderDetails(index) {
        selectedTableIndex = index;
        const table = tables[index];
        const order = table.order;
        const prepared = table.prepared;

        function renderSection(title, items, prepState, key) {
          if (!items || items.length === 0) return "";
          return `
                  <div class="section">
                    <h3>${title}</h3>
                    ${items
                      .map(
                        (item, i) => `
                      <div class="item">
                        <input type="checkbox" ${prepState[i] ? "checked" : ""}
                          onchange="togglePrepared(${index}, '${key}', ${i})">
                        <label>${item.name}</label>
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                `;
        }

        // Mapeia t√≠tulos bonitinhos para as categorias
        const categoryTitles = {
          plates: "Pratos",
          secondaryPlates: "Pratos Secund√°rios",
          sides: "Acompanhamentos",
          extras: "Extras",
          desserts: "Sobremesas",
          drinks: "Bebidas",
          coffee: "Caf√©s",
        };

        let sectionsHtml = "";
        for (const key in order) {
          if (key === "status") continue; // pular status
          const items = order[key];
          const prepState = prepared[key] || [];
          const title = categoryTitles[key] || key;
          sectionsHtml += renderSection(title, items, prepState, key);
        }

        orderDetails.innerHTML = `
  <h2 style="margin-bottom: 1rem;">
    ${table.name} - <span style="color: ${
          table.open ? "#28a745" : "#dc3545"
        };">${table.open ? "Aberta" : "Fechada"}</span>
  </h2>

  <!-- Nota da Cozinha -->
  <div class="section" style="margin-bottom: 20px;">
    <label for="kitchenNote" style="font-weight:600; margin-bottom:5px; display:block;">Nota da Cozinha:</label>
    <textarea id="kitchenNote" rows="3" style="width:100%; box-sizing:border-box; padding:8px; border-radius:6px; border:1px solid #ccc;">${
      table.kitchenNote
    }</textarea>
    <button class="btn btn-primary" onclick="saveKitchenNote(${index})" style="margin-top:10px;">Guardar Nota</button>
  </div>

  <!-- Status de Pagamento -->
  <div class="section" style="margin-bottom:20px;">
    <label style="font-weight:600; margin-bottom:5px; display:block;">Status do Pagamento:</label>
    <div class="status ${
      order.status === "paid" ? "paid" : "unpaid"
    }" style="margin-bottom:10px; padding:8px 12px; border-radius:6px; background-color:${
          order.status === "paid" ? "#d4edda" : "#f8d7da"
        }; color:${order.status === "paid" ? "#155724" : "#721c24"};">
      ${order.status === "paid" ? "Pago" : "Por Pagar"}
    </div>
    <button class="btn btn-secondary" onclick="togglePaid(${index})">
      Marcar como ${order.status === "paid" ? "Por Pagar" : "Pago"}
    </button>
  </div>

  <!-- Abrir/Fechar Mesa e Fatura -->
  <div class="section" style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
    <button class="btn btn-secondary" onclick="toggleOpenClose(${index})">
      ${table.open ? "Fechar Mesa" : "Abrir Mesa"}
    </button>
    <button class="btn btn-primary" onclick="openModal(${index})">Emitir Fatura</button>
  </div>

  <!-- Se√ß√µes adicionais -->
  <div class="section">
    ${sectionsHtml}
  </div>
`;
      }

      window.togglePrepared = function (tableIndex, section, itemIndex) {
        tables[tableIndex].prepared[section][itemIndex] =
          !tables[tableIndex].prepared[section][itemIndex];
        renderOrderDetails(tableIndex);
      };

      window.togglePaid = function (index) {
        const order = tables[index].order;
        order.status = order.status === "paid" ? "unpaid" : "paid";
        renderOrderDetails(index);
        renderTables();
      };

      window.toggleOpenClose = function (index) {
        tables[index].open = !tables[index].open;
        renderOrderDetails(index);
        renderTables();
      };

      window.saveKitchenNote = function (index) {
        const textarea = document.getElementById("kitchenNote");
        tables[index].kitchenNote = textarea.value.trim();
        renderTables();
      };
      function toggleLoginForm() {
        const form = document.getElementById("moloniLoginForm");
        form.style.display = form.style.display === "none" ? "block" : "none";
      }
      function closeCreateTableModal() {
        document.getElementById("createTableModal").style.display = "none";
      }
      window.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        const error = params.get("error");
        const tokenDisplayDiv = document.getElementById("tokenDisplay");
        let valid = false;
        let moloniProducts = [];
        console.log("Code da URL:", code);

        if (localStorage.getItem("moloni_token")) {
          valid = true;
        }
        // Esconder todos os elementos protegidos por default
        document.querySelectorAll(".protected").forEach((el) => {
          el.style.display = "none";
        });

        // Mostra mainContent se v√°lido
        if (valid) {
          document.getElementById("mainContent").style.display = "block";
          document.querySelectorAll(".protected").forEach((el) => {
            el.style.display = "inline-block"; // links e bot√µes
          });
          if (typeof renderTables === "function") renderTables();
        }

        if (code) {
          try {
            const res = await fetch("/api/moloni-exchange-code", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ code }),
            });
            const { access_token, refresh_token } = await res.json();
            console.log("Tokens recebidos:", access_token, refresh_token);

            alert("Tokens armazenados com sucesso!");
            history.replaceState({}, "", "/login.html");
            valid = true;
            tokenDisplayDiv.textContent = "‚úîÔ∏è Sistema pronto a usar";
            document.getElementById("mainContent").style.display = "block";
            document.querySelectorAll(".protected").forEach((el) => {
              el.style.display = "inline-block";
            });
            if (typeof renderTables === "function") renderTables();
          } catch (err) {
            console.error("Erro a obter tokens:", err);
            alert("Erro no login com Moloni.");
            tokenDisplayDiv.textContent = "‚ö†Ô∏è Erro no login com Moloni.";
          }
        }

        try {
          const res = await fetch("/api/moloni-token-status");
          const { valid } = await res.json();
          tokenDisplayDiv.textContent = valid
            ? "‚úîÔ∏è Sistema pronto a usar"
            : "‚ö†Ô∏è Sistema n√£o autenticado";
          updateUI(valid);

          const loginLink = document.getElementById("moloniLoginLink");

          if (valid) {
            loginLink.classList.add("disabled-link"); // desativa link
          } else {
            loginLink.classList.remove("disabled-link"); // ativa link
          }
          if (valid) {
            document.getElementById("mainContent").style.display = "block";
            document.querySelectorAll(".protected").forEach((el) => {
              el.style.display = "inline-block";
            });
            if (typeof renderTables === "function") renderTables();
          }

          if (error) {
            alert(
              "Erro durante o login com Moloni: " + decodeURIComponent(error)
            );
            tokenDisplayDiv.textContent = "‚ö†Ô∏è Erro no login com Moloni.";
          }

          if (typeof renderTables === "function") {
            renderTables();
          }
        } catch (err) {
          console.error("Erro ao verificar status do token:", err);
          tokenDisplayDiv.textContent = "‚ùå Erro ao verificar autentica√ß√£o.";
        }
      }); // fecha o DOMContentLoaded corretamente aqui
      function updateUI(isValid) {
        const tokenDisplayDiv = document.getElementById("tokenDisplay");
        const mainContent = document.getElementById("mainContent");

        if (isValid) {
          tokenDisplayDiv.textContent = "‚úîÔ∏è Sistema pronto a usar";
          mainContent.style.display = "block";
          document.querySelectorAll(".protected").forEach((el) => {
            el.style.display = "inline-block";
          });
        } else {
          tokenDisplayDiv.textContent = "‚ö†Ô∏è Sistema n√£o autenticado";
          mainContent.style.display = "none";
          document.querySelectorAll(".protected").forEach((el) => {
            el.style.display = "none";
          });
          const modal = document.getElementById("createTableModal");
          if (modal) modal.style.display = "none";
        }
      }
      function convertOrderToMoloniProducts(order) {
        const sections = [
          "plates",
          "secondaryPlates",
          "sides",
          "extras",
          "desserts",
          "drinks",
          "coffee",
        ];
        const products = [];

        sections.forEach((section) => {
          if (!order[section]) order[section] = [];

          order[section].forEach((item) => {
            // item j√° tem product_id, name, price, tax_id
            products.push({
              product_id: item.product_id,
              name: item.name,
              qty: item.qty || 1,
              unit_name: "Unidade",
              unit_short_name: "Un",
              price: item.price,
              taxes: [{ tax_id: item.tax_id }],
            });
          });
        });

        console.log("Produtos que v√£o para Moloni:", products);
        return products;
      }

      let moloniProducts = []; // global, para todas as fun√ß√µes

      async function openCreateTableModal() {
        // Limpa os containers de bot√µes
        const containerIds = [
          "principalArticles",
          "secondaryArticles",
          "sideArticles",
          "dessertArticles",
          "drinkArticles",
          "extraArticles",
        ];
        containerIds.forEach((id) => {
          document.getElementById(id).innerHTML = "";
        });

        try {
          const response = await fetch("/artigo/artigos");
          if (!response.ok) throw new Error("Erro ao buscar artigos");

          const artigos = await response.json();
          moloniProducts = artigos; // guarda globalmente

          artigos.forEach((artigo) => {
            const categoria = (artigo.summary || "")
              .trim()
              .toLowerCase()
              .normalize("NFD")
              .replace(/[\u0300-\u036f]/g, "");

            let containerId;
            if (categoria === "prato principal")
              containerId = "principalArticles";
            else if (categoria === "prato secundario")
              containerId = "secondaryArticles";
            else if (categoria === "acompanhamento")
              containerId = "sideArticles";
            else if (categoria === "sobremesa") containerId = "dessertArticles";
            else if (categoria === "bebida") containerId = "drinkArticles";
            else if (categoria === "extra") containerId = "extraArticles";
            else return; // ignora categorias desconhecidas

            const container = document.getElementById(containerId);
            const btn = document.createElement("button");
            btn.type = "button";
            btn.textContent = artigo.name;
            btn.className = "article-btn";
            btn.dataset.selected = "false";
            btn.onclick = () => {
              btn.dataset.selected =
                btn.dataset.selected === "true" ? "false" : "true";
              btn.classList.toggle("selected");
            };
            btn.value = JSON.stringify({
              product_id: artigo.product_id,
              name: artigo.name,
              price: artigo.price,
              tax_id: artigo.tax_id || 3630173,
            });

            container.appendChild(btn);
          });

          document.getElementById("newTableName").value = "";
          document.getElementById("createTableModal").style.display = "flex";
        } catch (err) {
          alert("N√£o foi poss√≠vel carregar os artigos: " + err.message);
        }
      }

      function createNewTable() {
        const tableName = document.getElementById("newTableName").value.trim();
        if (!tableName) {
          alert("Insere um nome para a mesa!");
          return;
        }

        const newTable = {
          id: tables.length + 1,
          name: tableName,
          open: true,
          kitchenNote: "", // podes preencher se houver nota da cozinha
          order: {
            status: "unpaid",
            plates: getSelectedProductsFromButtons("principalArticles"),
            secondaryPlates:
              getSelectedProductsFromButtons("secondaryArticles"),
            sides: getSelectedProductsFromButtons("sideArticles"),
            desserts: getSelectedProductsFromButtons("dessertArticles"),
            drinks: getSelectedProductsFromButtons("drinkArticles"), // adicionado
            extras: getSelectedProductsFromButtons("extraArticles"), // adicionado
            coffee: [],
          },
          prepared: {
            plates: [],
            secondaryPlates: [],
            sides: [],
            desserts: [],
            drinks: [],
            coffee: [],
            extras: [],
          },
        };

        tables.push(newTable);
        renderTables();
        document.getElementById("createTableModal").style.display = "none";
      }
      function renderArticleButtons(containerId, articles) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        articles.forEach((article) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = article.name;
          btn.className = "article-btn";
          btn.dataset.selected = "false";
          btn.onclick = () => {
            btn.dataset.selected =
              btn.dataset.selected === "true" ? "false" : "true";
            btn.classList.toggle("selected");
          };
          btn.value = JSON.stringify(article);
          container.appendChild(btn);
        });
      }

      function getSelectedProductsFromButtons(containerId) {
        return Array.from(
          document.querySelectorAll(`#${containerId} .article-btn.selected`)
        ).map((btn) => JSON.parse(btn.value));
      }

      window.addEventListener("DOMContentLoaded", () => {
        const btn = document.querySelector(".btn");
        if (btn) btn.addEventListener("click", openCreateTableModal);
      });
    </script>
  </body>
</html>
