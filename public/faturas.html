<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Faturas Emitidas</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 2rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 0.5rem;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <h1>ðŸ“„ Faturas Emitidas</h1>
    <div id="faturaContainer">A carregar...</div>

    <form id="formAutoPdf">
      <label for="autoPdf">Seleciona o PDF do Auto para juntar:</label>
      <input
        type="file"
        id="autoPdf"
        name="autoPdf"
        accept="application/pdf"
        required
      />
      <label for="faturaPdf">Seleciona o PDF da Fatura:</label>
      <input
        type="file"
        id="faturaPdf"
        name="faturaPdf"
        accept="application/pdf"
        required
      />
      <button type="submit">Enviar e baixar PDF combinado</button>
    </form>

    <script>
      const form = document.getElementById("formAutoPdf");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const select = document.getElementById("faturaSelect");
        const documentId = select.value;
        if (!documentId) {
          alert("Selecione uma fatura");
          return;
        }

        const fileInput = document.getElementById("autoPdf");
        if (fileInput.files.length === 0) {
          alert("Selecione o PDF do Auto");
          return;
        }

        const formData = new FormData();
        formData.append("autoPdf", fileInput.files[0]);
        const faturaPdfInput = document.getElementById("faturaPdf");
        if (faturaPdfInput.files.length === 0) {
          alert("Selecione o PDF da fatura");
          return;
        }
        formData.append("faturaPdf", faturaPdfInput.files[0]);
        try {
          console.log("Enviando para o backend...", documentId);
          const response = await fetch(`/api/fatura-com-auto}`, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const text = await response.text();
            throw new Error(
              `Erro ao combinar PDFs: ${response.status} ${text}`
            );
          }

          const blob = await response.blob();
          const url = URL.createObjectURL(blob);

          // ForÃ§ar download do PDF combinado
          const a = document.createElement("a");
          a.href = url;
          a.download = `fatura_com_auto_${documentId}.pdf`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } catch (err) {
          alert(err.message);
        }
      });

      let faturas = [];
      async function fetchFaturas() {
        try {
          const response = await fetch("/api/faturas");
          faturas = await response.json();

          if (faturas.length === 0) {
            document.getElementById("faturaContainer").innerText =
              "Nenhuma fatura encontrada.";
            return;
          }

          const table = document.createElement("table");
          table.innerHTML = `
            <thead>
              <tr>
                <th>ID</th>
                <th>Data</th>
                <th>NÃºmero</th>
                <th>Total</th>
                <th>PDF</th>
                <th>Selecionar para juntar</th>
              </tr>
            </thead>
            <tbody>
              ${faturas
                .map(
                  (f) => `
                <tr>
                  <td>${f.document_id}</td>
                  <td>${f.date}</td>
                  <td>${f.document_number}</td>
                  <td>${f.total}</td>
                  <td><a href="${f.pdfUrl}" target="_blank">ðŸ“„ Abrir</a></td>
              
                </tr>
              `
                )
                .join("")}
            </tbody>
          `;
          document.getElementById("faturaContainer").innerHTML = "";
          document.getElementById("faturaContainer").appendChild(table);

          // Preencher o <select> dinamicamente
          const select = document.getElementById("faturaSelect");
          select.innerHTML = '<option value="">--Selecione--</option>';
          faturas.forEach((f) => {
            const option = document.createElement("option");
            option.value = f.document_id;
            option.textContent = `Fatura ${f.document_number} (${f.date})`;
            select.appendChild(option);
          });
        } catch (err) {
          console.error("Erro ao obter faturas:", err);
          document.getElementById("faturaContainer").innerText =
            "Erro ao carregar faturas.";
        }
      }

      fetchFaturas();
    </script>
  </body>
</html>
