<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Faturas Emitidas</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 2rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 0.5rem;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <h1>ðŸ“„ Faturas Emitidas</h1>
    <div id="faturaContainer">A carregar...</div>
    <div id="uploadSection" style="margin-top: 2rem">
      <h2>Juntar PDF Ã  fatura</h2>
      <label for="pdfUpload">Escolha o PDF a juntar:</label>
      <input type="file" id="pdfUpload" accept="application/pdf" />
      <button id="btnUpload" disabled>Enviar e juntar</button>
    </div>
    <form id="formAutoPdf" style="margin-top: 1rem">
      <label for="autoPdf">Seleciona o PDF do Auto para juntar:</label>
      <input
        type="file"
        id="autoPdf"
        name="autoPdf"
        accept="application/pdf"
        required
      />
      <button type="submit">Enviar e juntar ao PDF da fatura</button>
    </form>
    <script>
      const form = document.getElementById("formAutoPdf");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const selectedFatura = document.querySelector(
          'input[name="faturaSelecionada"]:checked'
        );
        if (!selectedFatura) {
          alert("Por favor selecione uma fatura.");
          return;
        }

        const documentId = selectedFatura.value;
        const fileInput = document.getElementById("autoPdf");
        const file = fileInput.files[0];
        if (!file) {
          alert("Por favor, selecione um ficheiro PDF");
          return;
        }

        const formData = new FormData();
        formData.append("autoPdf", file);

        try {
          const response = await fetch(`/api/fatura-com-auto/${documentId}`, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) throw new Error("Erro ao combinar PDFs");

          const blob = await response.blob();
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = `fatura_com_auto_${documentId}.pdf`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } catch (err) {
          alert(err.message);
        }
      });

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
      }
      let faturas = [];
      async function fetchFaturas() {
        try {
          const response = await fetch("/api/faturas");
          faturas = await response.json();

          if (faturas.length === 0) {
            document.getElementById("faturaContainer").innerText =
              "Nenhuma fatura encontrada.";
            return;
          }

          const table = document.createElement("table");
          table.innerHTML = `
        <thead>
          <tr>
            <th>ID</th>
            <th>Data</th>
            <th>NÃºmero</th>
            <th>Total</th>
            <th>PDF</th>
            <th>Selecionar para juntar</th>
          </tr>
        </thead>
        <tbody>
          ${faturas
            .map(
              (f) => `
            <tr>
              <td>${f.document_id}</td>
              <td>${f.date}</td>
              <td>${f.document_number}</td>
              <td>${f.total}</td>
              <td><a href="${f.pdfUrl}" target="_blank">ðŸ“„ Abrir</a></td>
              <td><input type="radio" name="faturaSelecionada" value="${f.document_id}"></td>
            </tr>
          `
            )
            .join("")}
        </tbody>
      `;
          document.getElementById("faturaContainer").innerHTML = "";
          document.getElementById("faturaContainer").appendChild(table);
        } catch (err) {
          console.error("Erro ao obter faturas:", err);
          document.getElementById("faturaContainer").innerText =
            "Erro ao carregar faturas.";
        }
      }

      fetchFaturas();

      // Habilitar botÃ£o sÃ³ se tiver arquivo e fatura selecionada
      const pdfInput = document.getElementById("pdfUpload");
      const btnUpload = document.getElementById("btnUpload");

      function checkEnableButton() {
        const selectedFatura = document.querySelector(
          'input[name="faturaSelecionada"]:checked'
        );
        btnUpload.disabled = !(pdfInput.files.length > 0 && selectedFatura);
      }

      pdfInput.addEventListener("change", checkEnableButton);
      document
        .getElementById("faturaContainer")
        .addEventListener("change", checkEnableButton);

      btnUpload.addEventListener("click", async () => {
        const selectedFatura = document.querySelector(
          'input[name="faturaSelecionada"]:checked'
        );
        if (!selectedFatura) {
          alert("Por favor selecione uma fatura.");
          return;
        }

        const file = pdfInput.files[0];
        if (!file) {
          alert("Por favor escolha um arquivo PDF.");
          return;
        }

        const formData = new FormData();
        formData.append("pdf", file);
        formData.append("document_id", selectedFatura.value);

        try {
          const res = await fetch("/api/fatura-com-auto", {
            method: "POST",
            body: formData,
          });

          if (!res.ok) {
            throw new Error("Erro no servidor");
          }

          // Supondo que o backend responde com link para o PDF combinado
          const data = await res.json();
          window.open(data.combinedPdfUrl, "_blank");
        } catch (err) {
          alert("Erro ao enviar o arquivo: " + err.message);
        }
      });
    </script>
  </body>
</html>
