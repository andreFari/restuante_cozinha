<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Faturas Emitidas</title>
    <link rel="stylesheet" href="css/header.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background-color: #f7f8fa;
        color: #333;
      }
      h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 1.5rem;
        margin-top: 1.5rem;
      }

      form label {
        display: block;
        font-weight: 600;
        color: #34495e;
        margin-top: 1rem;
        margin-bottom: 5%;
      }

      form input[type="file"] {
        width: 100%;
        padding: 0.4rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
      }

      form button {
        display: block;
        width: 100%;
        margin-top: 1.5rem;
        padding: 0.8rem;
        background: #2980b9;
        border: none;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s ease;
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
      }

      form button:hover:not(:disabled) {
        background: #1c5980;
      }

      button:disabled {
        background: #7f8c8d;
        cursor: not-allowed;
      }
      button:hover:not(:disabled) {
        background: #1c5980;
      }
      #statusMessage {
        text-align: center;
        margin-bottom: 1rem;
        font-weight: 600;
        color: #27ae60;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      th,
      td {
        padding: 0.75rem 1rem;
        text-align: left;
      }
      thead {
        background: #2980b9;
        color: white;
      }
      tbody tr:nth-child(even) {
        background: #f4f6f8;
      }
      tbody tr:hover {
        background: #d6eaff;
      }
      a.pdf-link {
        text-decoration: none;
        color: #2980b9;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
      }
      a.pdf-link:hover {
        text-decoration: underline;
      }
      a.pdf-link::before {
        content: "üìÑ";
      }
      @media (max-width: 600px) {
        form {
          flex-direction: column;
          gap: 0.8rem;
        }
        label,
        input[type="file"],
        button {
          flex: 1 1 100%;
        }
        th,
        td {
          font-size: 0.9rem;
        }
      }
      #autoPdf {
        text-align: center;
      }
      #faturaPdf {
        text-align: center;
      }
    </style>
  </head>

  <body>
    <div id="header-placeholder"></div>

    <div style="padding: 20px">
      <h1>üìÑ Faturas Emitidas</h1>
      <form id="formAutoPdf">
        <label for="autoPdf">Seleciona o PDF do Auto para juntar:</label>
        <input
          type="file"
          id="autoPdf"
          name="autoPdf"
          accept="application/pdf"
          required
        />
        <label for="faturaPdf">Seleciona o PDF da Fatura:</label>
        <input
          type="file"
          id="faturaPdf"
          name="faturaPdf"
          accept="application/pdf"
          required
        />
        <button type="submit">Exportar PDF combinado</button>
        <label for="periodStart">Data de in√≠cio:</label>
        <input type="date" id="periodStart" name="periodStart" />

        <label for="periodEnd">Data de fim:</label>
        <input type="date" id="periodEnd" name="periodEnd" />
        <button id="gerarSaftBtn">üìÅ Gerar SAF-T</button>
        <div
          id="statusSaft"
          style="text-align: center; margin-top: 10px; color: #27ae60"
        ></div>
      </form>

      <div id="faturaContainer">A carregar...</div>
    </div>
    <script>
      const form = document.getElementById("formAutoPdf");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const fileAuto = document.getElementById("autoPdf");
        const fileFatura = document.getElementById("faturaPdf");

        if (fileAuto.files.length === 0) {
          alert("Selecione o PDF do Auto");
          return;
        }
        if (fileFatura.files.length === 0) {
          alert("Selecione o PDF da fatura");
          return;
        }

        const formData = new FormData();
        formData.append("autoPdf", fileAuto.files[0]);
        formData.append("faturaPdf", fileFatura.files[0]);

        try {
          const response = await fetch("/api/fatura-com-auto", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const text = await response.text();
            throw new Error(
              `Erro ao combinar PDFs: ${response.status} ${text}`
            );
          }

          const blob = await response.blob();
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = `fatura_com_auto_${Date.now()}.pdf`; // nome gen√©rico com timestamp
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } catch (err) {
          alert(err.message);
        }
      });

      let faturas = [];
      async function fetchFaturas() {
        try {
          const response = await fetch("/api/faturas");
          const data = await response.json(); // use uma vari√°vel 'data'
          faturas = Array.isArray(data) ? data : [];
          if (faturas.length === 0) {
            document.getElementById("faturaContainer").innerText =
              "Nenhuma fatura encontrada.";
            return;
          }
          // Ordenar pela data decrescente
          faturas.sort((a, b) => new Date(b.date) - new Date(a.date));
          const table = document.createElement("table");
          table.innerHTML = `
           <thead>
        <tr>
          <th>ID</th>
          <th>Data</th>
          <th>N√∫mero</th>
          <th>Il√≠quido</th>
          <th>Impostos</th>
          <th>Total Liq.</th>
          <th>D√≠vida</th>
             <th>Email</th>
          <th>PDF</th>
       
        </tr>
      </thead>
      <tbody>
        ${faturas
          .map((f) => {
            const dataFormatada = new Date(f.date).toLocaleDateString("pt-PT");

            const formatarValor = (v) =>
              v != null ? parseFloat(v).toFixed(2) + " ‚Ç¨" : "-";

            return `
              <tr>
                <td>${f.document_id}</td>
                <td>${dataFormatada}</td>
                <td>${f.document_number || "-"}</td>
                <td>${formatarValor(f.net_value)}</td>
                <td>${formatarValor(f.total_tax)}</td>
                <td>${formatarValor(f.total_value)}</td>
                <td>${formatarValor(f.total_due ?? f.total_balance)}</td>
                <td>
  <button class="btn btn-secondary" onclick="enviarFaturaEmail('${
    f.document_id
  }')">
    üìß Enviar
  </button>
</td>
                <td><a href="${f.pdfUrl}" target="_blank">üìÑ Abrir</a></td>
              </tr>
            `;
          })
          .join("")}
      </tbody>
    `;
          document.getElementById("faturaContainer").innerHTML = "";
          document.getElementById("faturaContainer").appendChild(table);
        } catch (err) {
          console.error("Erro ao obter faturas:", err);
          document.getElementById("faturaContainer").innerText =
            "Erro ao carregar faturas.";
        }
      }

      fetchFaturas();

      async function enviarFaturaEmail(documentId) {
        const email = prompt("Digite o email do destinat√°rio:");

        if (!email) return;

        try {
          const response = await fetch("/api/enviar-fatura", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ document_id: documentId, email }),
          });

          if (!response.ok) {
            const text = await response.text();
            throw new Error(`Erro ao enviar fatura: ${text}`);
          }

          alert("Fatura enviada com sucesso!");
        } catch (err) {
          alert(err.message);
        }
      }
    </script>
    <script>
      const gerarSaftBtn = document.getElementById("gerarSaftBtn");
      const statusSaft = document.getElementById("statusSaft");

      gerarSaftBtn.addEventListener("click", async () => {
        gerarSaftBtn.disabled = true;
        statusSaft.innerText = "A gerar SAF-T, aguarde...";
        const periodStart = document.getElementById("periodStart").value;
        const periodEnd = document.getElementById("periodEnd").value;
        try {
          // Chamada ao endpoint que gera o SAF-T na Moloni
          const response = await fetch("/api/gerar-saft", {
            method: "POST",
          });

          if (!response.ok) {
            const text = await response.text();
            throw new Error(`Erro ao gerar SAF-T: ${text}`);
          }

          const blob = await response.blob();
          const url = URL.createObjectURL(blob);

          // Criar link de download do SAF-T
          const a = document.createElement("a");
          a.href = url;
          a.download = `SAFT_${new Date().toISOString().slice(0, 10)}.xml`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);

          statusSaft.innerText = "‚úÖ SAF-T gerado com sucesso!";
        } catch (err) {
          console.error(err);
          statusSaft.innerText = `‚ùå ${err.message}`;
        } finally {
          gerarSaftBtn.disabled = false;
        }
      });
    </script>
    <script src="./js/header.js"></script>
  </body>
</html>
