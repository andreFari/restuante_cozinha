<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Gerir Pratos - Moloni</title>
    <link rel="stylesheet" href="css/artigos.css" />
    <link rel="stylesheet" href="css/header.css" />
  </head>
  <body>
    <header>
      <div class="logo-title">
        <img src="" alt="Logo" class="logo" />
      </div>

      <div class="links-container">
        <nav id="navLinks">
          <a href="./takeway.html" class="protected">Takeway</a>
          <a href="./login.html" class="protected"> Rece√ß√£o Bar </a>
          <a href="./rececaoCozi.html" class="protected"> Rece√ß√£o Cozinha </a>
          <a href="./cozinha.html" class="protected"> Cozinha </a>
          <a href="./faturas.html" class="protected"> Ver Faturas</a>
          <!-- Layout principal: 2 colunas
          <a href="./guiasTransporte.html" class="protected"

            >üöö Guias de Transporte
          </a>
 -->
          <a href="./artigos.html" class="protected active"> Gerir Pratos</a>
          <a href="./menu.html" class="protected">Menu</a>
          <a href="./gest_mesas.html" class="protected"> Gest√£o mesas</a>
        </nav>
      </div>

      <div id="tokenDisplay" class="token-status">
        ‚ö†Ô∏è Sistema n√£o autenticado
      </div>
    </header>

    <h1>Lista de Pratos</h1>

    <div class="message success" id="msgSuccess"></div>
    <div class="message error" id="msgError"></div>

    <div class="top-bar">
      <input
        type="text"
        id="search"
        class="search-input"
        placeholder="Pesquisar..."
      />
      <div>
        <button id="syncBtn">üîÑ Sincronizar</button>
        <button id="openModalBtn">‚ûï Criar Novo Prato</button>
        <button id="toggleOrderBtn">‚öôÔ∏è Ajustar posi√ß√µes</button>
      </div>
    </div>
    <!-- üî• Barra de Se√ß√µes -->
    <div style="text-align: center; margin: 10px">
      <button class="sectionBtn" data-cat="Bebidas">ü•§ Bebidas</button>
      <button class="sectionBtn" data-cat="Principais">üçΩÔ∏è Principais</button>
      <button class="sectionBtn" data-cat="Secundarios">üç≤ Secund√°rios</button>
      <button class="sectionBtn" data-cat="Extras">‚ûï Extras</button>
      <button class="sectionBtn" data-cat="Sobremesas">üç∞ Sobremesas</button>
      <button class="sectionBtn" data-cat="Todos">üìã Todos</button>
    </div>
    <!-- Grelha de artigos -->
    <div class="grid" id="productGrid"></div>

    <!-- Modal Detalhes -->
    <div id="productModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h2 id="modalTitle">Detalhes do Prato</h2>
        <div id="modalBody"></div>
        <div style="margin-top: 15px; text-align: right">
          <button id="editBtn">‚úèÔ∏è Editar</button>
          <button id="deleteBtn" style="background: #d9534f">
            üóëÔ∏è Eliminar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Formul√°rio Criar/Editar -->
    <div id="formModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeForm">&times;</span>
        <h2 id="formTitle">‚ûï Criar Novo Prato</h2>
        <form id="productForm">
          <label>Nome *</label>
          <input type="text" id="name" required />

          <label>Categoria *</label>
          <input type="text" id="category_id" required />

          <label>Refer√™ncia *</label>
          <input type="text" id="reference" required />

          <label>Pre√ßo *</label>
          <input type="number" step="0.01" id="price" required />

          <label>IVA *</label>
          <input type="text" id="tax_id" required />

          <label>Descri√ß√£o</label>
          <input type="text" id="summary" />

          <label>EAN</label>
          <input type="text" id="ean" />

          <button type="submit">Salvar</button>
        </form>
      </div>
    </div>

    <script>
      let produtos = []; // array global com todos os produtos
      let ordemPorCategoria = {}; // map de arrays por categoria
      let orderMode = false; // modo organiza√ß√£o
      let currentCategory = "Todos"; // categoria ativa

      const categorias = [
        "Todos",
        "Bebidas",
        "Principais",
        "Secundarios",
        "Extras",
        "Sobremesas",
      ];

      // Mostrar mensagens
      function showMessage(type, text) {
        const msg =
          type === "success"
            ? document.getElementById("msgSuccess")
            : document.getElementById("msgError");
        msg.textContent = text;
        msg.style.display = "block";
        setTimeout(() => (msg.style.display = "none"), 3000);
      }

      function categoriaMatches(p, cat) {
        const desc = (p.summary || "").toLowerCase();
        if (cat === "Todos") return true;
        if (cat === "Bebidas") return desc.includes("bebida");
        if (cat === "Principais") return desc.includes("principal");
        if (cat === "Secundarios")
          return desc.includes("secund√°rio") || desc.includes("secundario");
        if (cat === "Extras") return desc.includes("extra");
        if (cat === "Sobremesas") return desc.includes("sobremesa");
        return false;
      }

      function renderGrid() {
        const grid = document.getElementById("productGrid");
        grid.innerHTML = "";

        if (!ordemPorCategoria[currentCategory])
          ordemPorCategoria[currentCategory] = produtos.filter((p) =>
            categoriaMatches(p, currentCategory)
          );

        const data = ordemPorCategoria[currentCategory];

        data.forEach((prod, index) => {
          const card = document.createElement("div");
          card.className = "card";
          card.dataset.index = index;
          card.style.backgroundImage = `url(${
            prod.image_url || "imagens/placeholder.jpg"
          })`;
          card.style.backgroundSize = "cover";
          card.style.backgroundPosition = "center";

          const overlay = document.createElement("div");
          overlay.className = "overlay";
          overlay.innerHTML = `<h3>${prod.name}</h3><p>${prod.price} ‚Ç¨</p><small>${prod.category_id}</small>`;
          card.appendChild(overlay);

          if (orderMode) {
            const controls = document.createElement("div");
            controls.className = "controls";
            controls.innerHTML = `<button class="moveLeft">‚¨Ö</button><button class="moveRight">‚û°</button>`;
            controls.querySelector(".moveLeft").onclick = (e) => {
              e.stopPropagation();
              moveItem(index, -1);
            };
            controls.querySelector(".moveRight").onclick = (e) => {
              e.stopPropagation();
              moveItem(index, 1);
            };
            card.appendChild(controls);
          } else {
            card.onclick = () => openDetails(prod);
          }

          grid.appendChild(card);
        });
      }

      function moveItem(index, direction) {
        const arr = ordemPorCategoria[currentCategory];
        const targetIndex = index + direction;
        if (targetIndex < 0 || targetIndex >= arr.length) return;

        [arr[index], arr[targetIndex]] = [arr[targetIndex], arr[index]];

        renderGrid();
      }

      document.getElementById("toggleOrderBtn").onclick = () => {
        orderMode = !orderMode;
        document.getElementById("toggleOrderBtn").textContent = orderMode
          ? "‚úÖ Guardar ordem"
          : "‚öôÔ∏è Ajustar posi√ß√µes";

        if (!orderMode) {
          // salvar no localStorage por categoria
          localStorage.setItem(
            "ordemPorCategoria",
            JSON.stringify(ordemPorCategoria)
          );
          showMessage("success", "Ordem guardada!");
        }

        renderGrid();
      };

      let currentEditId = null; // para saber se estamos a editar ou criar

      // Abrir modal de detalhes
      function openDetails(prod) {
        document.getElementById("modalTitle").textContent = prod.name;
        document.getElementById("modalBody").innerHTML = `
    <p><strong>ID:</strong> ${prod.product_id}</p>
    <p><strong>Refer√™ncia:</strong> ${prod.reference}</p>
    <p><strong>Pre√ßo:</strong> ${prod.price} ‚Ç¨</p>
    <p><strong>Categoria:</strong> ${prod.category_id}</p>
    <p><strong>IVA:</strong> ${prod.tax_id}</p>
    <p><strong>Descri√ß√£o:</strong> ${prod.summary || "-"}</p>
    <p><strong>EAN:</strong> ${prod.ean || "-"}</p>
  `;

        document.getElementById("editBtn").onclick = () => openEditForm(prod);
        document.getElementById("deleteBtn").onclick = () =>
          deleteProduct(prod.product_id);

        modal.style.display = "flex";
      }

      // Renderiza√ß√£o com filtro
      /*function renderGrid(data) {
        const grid = document.getElementById("productGrid");
        grid.innerHTML = "";

        // üî• aplicar filtro pela categoria
        let filtered = data;
        if (currentCategory !== "Todos") {
          filtered = data.filter((p) => {
            const descricao = (p.summary || "").toLowerCase();

            if (currentCategory === "Bebidas") {
              return descricao.includes("bebida");
            }
            if (currentCategory === "Principais") {
              return descricao.includes("principal");
            }
            if (currentCategory === "Secundarios") {
              return (
                descricao.includes("secund√°rio") ||
                descricao.includes("secundario")
              );
            }
            if (currentCategory === "Extras") {
              return descricao.includes("extra");
            }
            if (currentCategory === "Sobremesas") {
              return descricao.includes("sobremesa");
            }
            return false;
          });
        }

        filtered.forEach((prod, index) => {
          const card = document.createElement("div");
          card.className = "card";
          card.draggable = true;
          card.dataset.index = index;

          card.innerHTML = `
      <h3>${prod.name}</h3>
      <p>${prod.price} ‚Ç¨</p>
      <small>Categoria: ${prod.category_id}</small>
    `;

          card.onclick = (e) => {
            if (!card.classList.contains("dragging")) {
              openDetails(prod);
            }
          };

          card.addEventListener("dragstart", (e) => {
            card.classList.add("dragging");
            e.dataTransfer.effectAllowed = "move";
          });

          card.addEventListener("dragend", () => {
            card.classList.remove("dragging");
            updateOrder();
          });

          grid.appendChild(card);
        });

        grid.addEventListener("dragover", (e) => {
          e.preventDefault();
          const dragging = document.querySelector(".dragging");
          const afterElement = getDragAfterElement(grid, e.clientY);
          if (afterElement == null) {
            grid.appendChild(dragging);
          } else {
            grid.insertBefore(dragging, afterElement);
          }
        });
      }
*/

      // Clique nos bot√µes de categoria
      document.querySelectorAll(".sectionBtn").forEach((btn) => {
        btn.addEventListener("click", () => {
          currentCategory = btn.dataset.cat;
          renderGrid();
        });
      });

      // Abrir formul√°rio para editar
      function openEditForm(prod) {
        modal.style.display = "none"; // fecha detalhes
        const formModal = document.getElementById("formModal");
        const form = document.getElementById("productForm");

        // Preenche campos
        document.getElementById("formTitle").textContent = "‚úèÔ∏è Editar Prato";
        document.getElementById("name").value = prod.name;
        document.getElementById("category_id").value = prod.category_id;
        document.getElementById("reference").value = prod.reference;
        document.getElementById("price").value = prod.price;
        document.getElementById("tax_id").value = prod.tax_id;
        document.getElementById("summary").value = prod.summary || "";
        document.getElementById("ean").value = prod.ean || "";

        currentEditId = prod.product_id; // guardamos o id

        formModal.style.display = "flex";
      }

      // Abrir formul√°rio para criar novo prato
      document.getElementById("openModalBtn").onclick = () => {
        const form = document.getElementById("productForm");
        form.reset();
        document.getElementById("formTitle").textContent =
          "‚ûï Criar Novo Prato";
        currentEditId = null;
        document.getElementById("formModal").style.display = "flex";
      };

      // Submeter formul√°rio
      document
        .getElementById("productForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const product = {
            name: document.getElementById("name").value,
            category_id: document.getElementById("category_id").value,
            reference: document.getElementById("reference").value,
            price: parseFloat(document.getElementById("price").value),
            tax_id: document.getElementById("tax_id").value,
            summary: document.getElementById("summary").value,
            ean: document.getElementById("ean").value,
          };

          let url = "/artigo/artigos";
          let method = "POST";

          if (currentEditId) {
            url = `/artigo/artigos/${currentEditId}`;
            method = "PUT";
          }

          try {
            const res = await fetch(url, {
              method,
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(product),
            });

            if (!res.ok) throw new Error();

            showMessage(
              "success",
              currentEditId ? "Prato atualizado com sucesso!" : "Prato criado!"
            );
            document.getElementById("formModal").style.display = "none";
            fetchProducts();
          } catch {
            showMessage("error", "Erro ao salvar prato.");
          }
        });

      // Fechar modais
      document.getElementById("closeModal").onclick = () =>
        (modal.style.display = "none");
      document.getElementById("closeForm").onclick = () =>
        (document.getElementById("formModal").style.display = "none");

      // Fechar modal
      const modal = document.getElementById("productModal");
      document.getElementById("closeModal").onclick = () =>
        (modal.style.display = "none");
      window.onclick = (e) => {
        if (e.target == modal) modal.style.display = "none";
      };

      // Pesquisa instant√¢nea
      document.getElementById("search").addEventListener("input", function () {
        const term = this.value.toLowerCase();
        renderGrid(produtos.filter((p) => p.name.toLowerCase().includes(term)));
      });
      async function fetchProducts() {
        const res = await fetch("/artigo/artigos");
        produtos = await res.json();
        if (!Array.isArray(produtos)) produtos = produtos.products || [];

        // restaurar ordem do localStorage
        const ordemGuardada = JSON.parse(
          localStorage.getItem("ordemPorCategoria") || "{}"
        );
        ordemPorCategoria = {};

        categorias.forEach((cat) => {
          const ids = ordemGuardada[cat]?.map((p) => p.product_id) || [];
          const produtosCat = produtos.filter((p) => categoriaMatches(p, cat));
          if (ids.length) {
            // manter ordem guardada
            const mapById = new Map(produtosCat.map((p) => [p.product_id, p]));
            ordemPorCategoria[cat] = ids
              .map((id) => mapById.get(id))
              .filter(Boolean);
            // adicionar novos produtos n√£o guardados
            ordemPorCategoria[cat].push(
              ...produtosCat.filter((p) => !ids.includes(p.product_id))
            );
          } else {
            ordemPorCategoria[cat] = produtosCat;
          }
        });

        renderGrid();
      }

      async function deleteProduct(id) {
        if (!confirm("Eliminar este produto?")) return;
        try {
          const res = await fetch(`/artigo/artigos/${id}`, {
            method: "DELETE",
          });
          if (!res.ok) throw new Error();
          showMessage("success", "Produto eliminado com sucesso!");
          fetchProducts();
          modal.style.display = "none";
        } catch {
          showMessage("error", "Erro ao eliminar produto.");
        }
      }

      // Inicializar
      fetchProducts();
    </script>
  </body>
</html>
