<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Gerir Pratos - Moloni</title>
    <link rel="stylesheet" href="css/artigos.css" />
    <link rel="stylesheet" href="css/header.css" />
  </head>
  <body>
    <header>
      <div class="logo-title"><img src="" alt="Logo" class="logo" /></div>
      <div class="links-container">
        <nav id="navLinks">
          <a href="./login.html">Receção Bar</a>
          <a href="./rececaoCozi.html">Receção Cozinha</a>
          <a href="./cozinha.html">Cozinha</a>
          <a href="./faturas.html">📄 Ver Faturas</a>
          <a href="./artigos.html" class="active">🍽️ Gerir Pratos</a>
          <a href="./menu.html">📋 Menu</a>
        </nav>
      </div>
    </header>

    <h1>🍽️ Lista de Pratos</h1>

    <div class="message success" id="msgSuccess"></div>
    <div class="message error" id="msgError"></div>

    <div class="top-bar">
      <input
        type="text"
        id="search"
        class="search-input"
        placeholder="Pesquisar..."
      />
      <div>
        <button id="syncBtn">🔄 Sincronizar</button>
        <button id="openModalBtn">➕ Criar Novo Prato</button>
      </div>
    </div>
    <!-- 🔥 Barra de Seções -->
    <div style="text-align: center; margin: 10px">
      <button class="sectionBtn" data-cat="Bebidas">🥤 Bebidas</button>
      <button class="sectionBtn" data-cat="Principais">🍽️ Principais</button>
      <button class="sectionBtn" data-cat="Secundarios">🍲 Secundários</button>
      <button class="sectionBtn" data-cat="Extras">➕ Extras</button>
      <button class="sectionBtn" data-cat="Sobremesas">🍰 Sobremesas</button>
      <button class="sectionBtn" data-cat="Todos">📋 Todos</button>
    </div>
    <!-- Grelha de artigos -->
    <div class="grid" id="productGrid"></div>

    <!-- Modal Detalhes -->
    <div id="productModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h2 id="modalTitle">Detalhes do Prato</h2>
        <div id="modalBody"></div>
        <div style="margin-top: 15px; text-align: right">
          <button id="editBtn">✏️ Editar</button>
          <button id="deleteBtn" style="background: #d9534f">
            🗑️ Eliminar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Formulário Criar/Editar -->
    <div id="formModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeForm">&times;</span>
        <h2 id="formTitle">➕ Criar Novo Prato</h2>
        <form id="productForm">
          <label>Nome *</label>
          <input type="text" id="name" required />

          <label>Categoria *</label>
          <input type="text" id="category_id" required />

          <label>Referência *</label>
          <input type="text" id="reference" required />

          <label>Preço *</label>
          <input type="number" step="0.01" id="price" required />

          <label>IVA *</label>
          <input type="text" id="tax_id" required />

          <label>Descrição</label>
          <input type="text" id="summary" />

          <label>EAN</label>
          <input type="text" id="ean" />

          <button type="submit">Salvar</button>
        </form>
      </div>
    </div>
    <script>
      let produtos = [];

      // Mostrar mensagens
      function showMessage(type, text) {
        const msg =
          type === "success"
            ? document.getElementById("msgSuccess")
            : document.getElementById("msgError");
        msg.textContent = text;
        msg.style.display = "block";
        setTimeout(() => (msg.style.display = "none"), 3000);
      }

      function renderGrid(data) {
        const grid = document.getElementById("productGrid");
        grid.innerHTML = "";

        data.forEach((prod, index) => {
          const card = document.createElement("div");
          card.className = "card";
          card.draggable = true; // <- torna arrastável
          card.dataset.index = index; // guardar a posição original

          card.innerHTML = `
      <h3>${prod.name}</h3>
      <p>${prod.price} €</p>
      <small>Ref: ${prod.reference}</small>
    `;

          card.onclick = (e) => {
            // só abre detalhes se não estivermos a arrastar
            if (!card.classList.contains("dragging")) {
              openDetails(prod);
            }
          };

          // Eventos drag & drop
          card.addEventListener("dragstart", (e) => {
            card.classList.add("dragging");
            e.dataTransfer.effectAllowed = "move";
          });

          card.addEventListener("dragend", () => {
            card.classList.remove("dragging");
            updateOrder();
          });

          grid.appendChild(card);
        });

        // Permitir drop dentro da grelha
        grid.addEventListener("dragover", (e) => {
          e.preventDefault();
          const dragging = document.querySelector(".dragging");
          const cards = [...grid.querySelectorAll(".card:not(.dragging)")];
          const afterElement = getDragAfterElement(grid, e.clientY);
          if (afterElement == null) {
            grid.appendChild(dragging);
          } else {
            grid.insertBefore(dragging, afterElement);
          }
        });
      }

      // Função para encontrar o elemento correto ao arrastar
      function getDragAfterElement(container, y) {
        const draggableElements = [
          ...container.querySelectorAll(".card:not(.dragging)"),
        ];

        return draggableElements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY }
        ).element;
      }

      // Atualizar array `produtos` conforme a nova ordem
      function updateOrder() {
        const newOrder = [];
        document.querySelectorAll(".card").forEach((card) => {
          const index = card.dataset.index;
          newOrder.push(produtos[index]);
        });
        produtos = newOrder;
        console.log(
          "Nova ordem:",
          produtos.map((p) => p.name)
        );

        // 👉 Aqui podes enviar para o backend se quiseres guardar no servidor:
        // fetch("/artigo/reordenar", { method:"POST", body: JSON.stringify(produtos) })
      }

      let currentEditId = null; // para saber se estamos a editar ou criar

      // Abrir modal de detalhes
      function openDetails(prod) {
        document.getElementById("modalTitle").textContent = prod.name;
        document.getElementById("modalBody").innerHTML = `
    <p><strong>ID:</strong> ${prod.product_id}</p>
    <p><strong>Referência:</strong> ${prod.reference}</p>
    <p><strong>Preço:</strong> ${prod.price} €</p>
    <p><strong>Categoria:</strong> ${prod.category_id}</p>
    <p><strong>IVA:</strong> ${prod.tax_id}</p>
    <p><strong>Descrição:</strong> ${prod.summary || "-"}</p>
    <p><strong>EAN:</strong> ${prod.ean || "-"}</p>
  `;

        document.getElementById("editBtn").onclick = () => openEditForm(prod);
        document.getElementById("deleteBtn").onclick = () =>
          deleteProduct(prod.product_id);

        modal.style.display = "flex";
      }

      let currentCategory = "Todos"; // categoria ativa

      // Renderização com filtro
      function renderGrid(data) {
        const grid = document.getElementById("productGrid");
        grid.innerHTML = "";

        // 🔥 aplicar filtro pela categoria
        let filtered = data;
        if (currentCategory !== "Todos") {
          filtered = data.filter((p) => {
            const descricao = (p.summary || "").toLowerCase();

            if (currentCategory === "Bebidas") {
              return descricao.includes("bebida");
            }
            if (currentCategory === "Principais") {
              return descricao.includes("principal");
            }
            if (currentCategory === "Secundarios") {
              return (
                descricao.includes("secundário") ||
                descricao.includes("secundario")
              );
            }
            if (currentCategory === "Extras") {
              return descricao.includes("extra");
            }
            if (currentCategory === "Sobremesas") {
              return descricao.includes("sobremesa");
            }
            return false;
          });
        }

        filtered.forEach((prod, index) => {
          const card = document.createElement("div");
          card.className = "card";
          card.draggable = true;
          card.dataset.index = index;

          card.innerHTML = `
      <h3>${prod.name}</h3>
      <p>${prod.price} €</p>
      <small>Categoria: ${prod.category_id}</small>
    `;

          card.onclick = (e) => {
            if (!card.classList.contains("dragging")) {
              openDetails(prod);
            }
          };

          card.addEventListener("dragstart", (e) => {
            card.classList.add("dragging");
            e.dataTransfer.effectAllowed = "move";
          });

          card.addEventListener("dragend", () => {
            card.classList.remove("dragging");
            updateOrder();
          });

          grid.appendChild(card);
        });

        grid.addEventListener("dragover", (e) => {
          e.preventDefault();
          const dragging = document.querySelector(".dragging");
          const afterElement = getDragAfterElement(grid, e.clientY);
          if (afterElement == null) {
            grid.appendChild(dragging);
          } else {
            grid.insertBefore(dragging, afterElement);
          }
        });
      }

      // Clique nos botões de categoria
      document.querySelectorAll(".sectionBtn").forEach((btn) => {
        btn.addEventListener("click", () => {
          currentCategory = btn.dataset.cat;
          renderGrid(produtos);
        });
      });

      // Abrir formulário para editar
      function openEditForm(prod) {
        modal.style.display = "none"; // fecha detalhes
        const formModal = document.getElementById("formModal");
        const form = document.getElementById("productForm");

        // Preenche campos
        document.getElementById("formTitle").textContent = "✏️ Editar Prato";
        document.getElementById("name").value = prod.name;
        document.getElementById("category_id").value = prod.category_id;
        document.getElementById("reference").value = prod.reference;
        document.getElementById("price").value = prod.price;
        document.getElementById("tax_id").value = prod.tax_id;
        document.getElementById("summary").value = prod.summary || "";
        document.getElementById("ean").value = prod.ean || "";

        currentEditId = prod.product_id; // guardamos o id

        formModal.style.display = "flex";
      }

      // Abrir formulário para criar novo prato
      document.getElementById("openModalBtn").onclick = () => {
        const form = document.getElementById("productForm");
        form.reset();
        document.getElementById("formTitle").textContent =
          "➕ Criar Novo Prato";
        currentEditId = null;
        document.getElementById("formModal").style.display = "flex";
      };

      // Submeter formulário
      document
        .getElementById("productForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const product = {
            name: document.getElementById("name").value,
            category_id: document.getElementById("category_id").value,
            reference: document.getElementById("reference").value,
            price: parseFloat(document.getElementById("price").value),
            tax_id: document.getElementById("tax_id").value,
            summary: document.getElementById("summary").value,
            ean: document.getElementById("ean").value,
          };

          let url = "/artigo/artigos";
          let method = "POST";

          if (currentEditId) {
            url = `/artigo/artigos/${currentEditId}`;
            method = "PUT";
          }

          try {
            const res = await fetch(url, {
              method,
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(product),
            });

            if (!res.ok) throw new Error();

            showMessage(
              "success",
              currentEditId ? "Prato atualizado com sucesso!" : "Prato criado!"
            );
            document.getElementById("formModal").style.display = "none";
            fetchProducts();
          } catch {
            showMessage("error", "Erro ao salvar prato.");
          }
        });

      // Fechar modais
      document.getElementById("closeModal").onclick = () =>
        (modal.style.display = "none");
      document.getElementById("closeForm").onclick = () =>
        (document.getElementById("formModal").style.display = "none");

      // Fechar modal
      const modal = document.getElementById("productModal");
      document.getElementById("closeModal").onclick = () =>
        (modal.style.display = "none");
      window.onclick = (e) => {
        if (e.target == modal) modal.style.display = "none";
      };

      // Pesquisa instantânea
      document.getElementById("search").addEventListener("input", function () {
        const term = this.value.toLowerCase();
        renderGrid(produtos.filter((p) => p.name.toLowerCase().includes(term)));
      });

      // Fetch produtos
      async function fetchProducts() {
        const res = await fetch("/artigo/artigos");
        produtos = await res.json();
        if (!Array.isArray(produtos)) produtos = produtos.products || [];
        renderGrid(produtos);
      }

      async function deleteProduct(id) {
        if (!confirm("Eliminar este produto?")) return;
        try {
          const res = await fetch(`/artigo/artigos/${id}`, {
            method: "DELETE",
          });
          if (!res.ok) throw new Error();
          showMessage("success", "Produto eliminado com sucesso!");
          fetchProducts();
          modal.style.display = "none";
        } catch {
          showMessage("error", "Erro ao eliminar produto.");
        }
      }

      // Inicializar
      fetchProducts();
    </script>
  </body>
</html>
