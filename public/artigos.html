<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Gerir Pratos - Moloni</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background-color: #f9f9f9;
        padding: 20px;
      }
      h1 {
        color: #333;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        padding: 10px;
        border: 1px solid #ccc;
      }
      th {
        background: #eee;
      }
      form {
        margin-top: 30px;
        background: #fff;
        padding: 20px;
        border-radius: 5px;
        max-width: 500px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      }
      label {
        display: block;
        margin-top: 10px;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
      }
      button {
        margin-top: 15px;
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <h1>üßæ Lista de Pratos (Moloni)</h1>
    <p><a href="/">‚Üê Voltar ao Painel</a></p>

    <table id="productTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>Refer√™ncia</th>
          <th>Pre√ßo</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <form id="newProductForm">
      <h2>‚ûï Criar Novo Prato</h2>
      <label>Nome *</label>
      <input type="text" id="name" required />
      <label>Categoria *</label>
      <select id="category_id" required>
        <option value="">-- Escolha uma categoria --</option>
      </select>
      <label>Refer√™ncia *</label>
      <input type="text" id="reference" required />

      <label>Pre√ßo (sem IVA) *</label>
      <input type="number" step="0.01" id="price" required />

      <label>IVA (tax_id) *</label>
      <input type="number" id="tax_id" value="3630173" required />

      <label>Unidade *</label>
      <input type="text" id="unit_id" value="1" required />

      <label>Resumo</label>
      <input type="text" id="summary" />

      <label>EAN</label>
      <input type="text" id="ean" />

      <button type="submit">Criar Prato</button>
    </form>

    <script>
      async function fetchCategorias() {
        try {
          const res = await fetch("/artigo/categorias");
          const data = await res.json();
          console.log("Resposta categorias raw:", data);

          const categorias = Array.isArray(data)
            ? data
            : data.productCategories || [];

          const select = document.getElementById("category_id");
          select.innerHTML =
            '<option value="">-- Escolha uma categoria --</option>';

          // Filtra categorias principais (parent_id == 0)
          const principais = categorias.filter((cat) => cat.parent_id === 0);

          principais.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.category_id;
            option.textContent = cat.name;
            select.appendChild(option);

            // Procura subcategorias desta categoria principal
            const subcats = categorias.filter(
              (sub) => sub.parent_id === cat.category_id
            );

            subcats.forEach((subcat) => {
              const subOption = document.createElement("option");
              subOption.value = subcat.category_id;
              subOption.textContent = "‚Äî " + subcat.name; // Indenta com tra√ßo para parecer hierarquia
              select.appendChild(subOption);
            });
          });
        } catch (err) {
          console.error("Erro ao carregar categorias:", err);
          alert(
            "Erro ao carregar categorias. Verifique a liga√ß√£o com o servidor."
          );
        }
      }

      async function fetchProducts() {
        const res = await fetch("/artigo/artigos");
        const data = await res.json();
        console.log("Resposta produtos:", data);

        // Ajuste aqui para o nome correto do array no JSON, ex: 'products'
        const produtos = data || [];

        const tbody = document.querySelector("#productTable tbody");
        tbody.innerHTML = "";

        produtos.forEach((prod) => {
          const row = document.createElement("tr");
          row.innerHTML = `
        <td>${prod.product_id}</td>
        <td>${prod.name}</td>
        <td>${prod.reference}</td>
        <td>${prod.price} ‚Ç¨</td>
        <td><button onclick="deleteProduct(${prod.product_id})">üóëÔ∏è</button></td>
      `;
          tbody.appendChild(row);
        });
      }

      async function deleteProduct(id) {
        if (!confirm("Tens a certeza que queres eliminar este produto?"))
          return;
        await fetch(`/artigo/artigos/${id}`, { method: "DELETE" });
        fetchProducts();
      }

      document
        .getElementById("newProductForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          document.addEventListener("DOMContentLoaded", async () => {
            try {
              // ‚ö†Ô∏è Altera a URL conforme onde o teu backend est√° hospedado
              const res = await fetch("/artigo/categorias");
              const categorias = await res.json();

              const select = document.getElementById("category_id");

              // Popular o dropdown com categorias
              categorias.forEach((cat) => {
                const option = document.createElement("option");
                option.value = cat.productCategory_id;
                option.textContent = cat.name;
                select.appendChild(option);
              });
            } catch (err) {
              console.error("Erro ao carregar categorias:", err);
              alert(
                "Erro ao carregar categorias. Verifique a liga√ß√£o com o servidor."
              );
            }
          });
          const product = {
            name: document.getElementById("name").value,
            reference: document.getElementById("reference").value,
            price: parseFloat(document.getElementById("price").value),
            tax_id: parseInt(document.getElementById("tax_id").value),
            unit_id: parseInt(document.getElementById("unit_id").value),
            summary: document.getElementById("summary").value,
            ean: document.getElementById("ean").value,
            category_id: parseInt(document.getElementById("category_id").value),
          };

          await fetch("artigo/artigos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(product),
          });

          e.target.reset();
          fetchProducts();
        });

      // Carrega categorias e produtos na inicializa√ß√£o
      fetchCategorias();
      fetchProducts();
    </script>
  </body>
</html>
