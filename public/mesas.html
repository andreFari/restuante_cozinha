<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestão de Mesas - Relatórios</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", Tahoma, sans-serif;
        background-color: #f4f6f8;
        color: #333;
        line-height: 1.6;
      }
      h1 {
        text-align: center;
        padding: 20px 0;
        background-color: #2c3e50;
        color: white;
        margin-top: 0;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        background: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .search-input {
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        width: 250px;
        font-size: 16px;
      }
      .btn {
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
      }
      .btn-primary {
        background-color: #3498db;
        color: white;
      }
      .btn-primary:hover {
        background-color: #2980b9;
      }
      .btn-success {
        background-color: #2ecc71;
        color: white;
      }
      .btn-success:hover {
        background-color: #27ae60;
      }
      .btn-danger {
        background-color: #e74c3c;
        color: white;
      }
      .btn-danger:hover {
        background-color: #c0392b;
      }
      .main-layout {
        display: flex;
        gap: 20px;
        margin-top: 20px;
      }
      .table-lists {
        flex: 1;
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        max-height: 600px;
        overflow-y: auto;
      }
      .table-section h3 {
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #eee;
        color: #2c3e50;
      }
      .table-item {
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 4px solid #3498db;
        background-color: #f9f9f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .table-item:hover {
        background-color: #e8f4fd;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .table-item.active {
        border-left: 4px solid #2ecc71;
        background-color: #e8f6ef;
      }
      .table-info {
        flex: 1;
      }
      .table-name {
        font-weight: bold;
        font-size: 18px;
        margin-bottom: 5px;
      }
      .table-meta {
        display: flex;
        gap: 15px;
        font-size: 14px;
        color: #7f8c8d;
      }
      .table-status {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }
      .status-closed {
        background-color: #e74c3c;
        color: white;
      }
      .invoice-paid {
        background-color: #2ecc71;
        color: white;
      }
      .order-details {
        flex: 2;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        max-height: 600px;
        overflow-y: auto;
      }
      .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }
      .order-title {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
      }
      .invoice-link {
        background-color: #3498db;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        font-weight: bold;
      }
      .invoice-link:hover {
        background-color: #2980b9;
      }
      .section {
        margin-bottom: 25px;
      }
      .section h4 {
        margin: 0 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        color: #2c3e50;
        font-size: 18px;
      }
      .items-table {
        width: 100%;
        border-collapse: collapse;
      }
      .items-table th,
      .items-table td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
      }
      .items-table th {
        background-color: #f2f2f2;
        font-weight: bold;
      }
      .items-table tr:hover {
        background-color: #f5f5f5;
      }
      .note-box {
        background-color: #fff4e6;
        border-left: 4px solid #ffa94d;
        padding: 15px;
        border-radius: 4px;
        margin-top: 20px;
      }
      .note-box h5 {
        margin: 0 0 10px 0;
        color: #d35400;
      }
      .empty-state {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
      }
      .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
        color: #bdc3c7;
      }

      /* Modal de relatórios */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: #fff;
        padding: 25px;
        border-radius: 8px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
      }
      .close {
        position: absolute;
        right: 15px;
        top: 15px;
        font-size: 24px;
        cursor: pointer;
        color: #7f8c8d;
      }
      .close:hover {
        color: #34495e;
      }
      .date-filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
      }
      .date-input {
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 16px;
      }
      .charts-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }
      .chart-box {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .chart-title {
        text-align: center;
        margin-bottom: 15px;
        font-weight: bold;
        color: #2c3e50;
      }
      .report-summary {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #3498db;
      }
      .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }
      .summary-item:last-child {
        border-bottom: none;
      }
      .summary-value {
        font-weight: bold;
        color: #2c3e50;
      }
      .export-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
      }
      @media (max-width: 1100px) {
        .charts-container {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 768px) {
        .main-layout {
          flex-direction: column;
        }
        .date-filters {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <h1>Gestão de Mesas</h1>

    <div class="container">
      <div class="top-bar">
        <input
          type="text"
          class="search-input"
          placeholder="Pesquisar mesas..."
          id="searchInput"
        />
        <button class="btn btn-success" id="reportBtn">
          <i class="fas fa-chart-bar"></i> Gerar Relatório
        </button>
      </div>

      <div class="main-layout">
        <!-- Coluna esquerda: lista de mesas -->
        <div class="table-lists">
          <div class="table-section">
            <h3>Mesas</h3>
            <div id="tablesList">
              <!-- As mesas serão carregadas aqui via JavaScript -->
            </div>
          </div>
        </div>

        <!-- Coluna direita: detalhes da mesa selecionada -->
        <div class="order-details" id="orderDetails">
          <div class="empty-state">
            <i class="fas fa-clipboard-list"></i>
            <p>Selecione uma mesa para ver os detalhes</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de relatórios -->
    <div id="reportModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h2><i class="fas fa-chart-pie"></i> Relatório de Vendas</h2>

        <div class="date-filters">
          <div>
            <label for="startDate">Data Inicial:</label>
            <input type="date" id="startDate" class="date-input" />
          </div>
          <div>
            <label for="endDate">Data Final:</label>
            <input type="date" id="endDate" class="date-input" />
          </div>
          <button class="btn btn-primary" id="generateReport">
            <i class="fas fa-sync-alt"></i> Gerar
          </button>
        </div>

        <div class="report-summary">
          <h3>Resumo do Período</h3>
          <div class="summary-item">
            <span>Total Faturado:</span>
            <span class="summary-value" id="totalRevenue">0,00 €</span>
          </div>
          <div class="summary-item">
            <span>Número de Mesas:</span>
            <span class="summary-value" id="totalTables">0</span>
          </div>
          <div class="summary-item">
            <span>Período:</span>
            <span class="summary-value" id="period">-</span>
          </div>
        </div>

        <div class="charts-container">
          <div class="chart-box">
            <div class="chart-title">Pratos Mais Vendidos</div>
            <canvas id="dishesChart"></canvas>
          </div>
          <div class="chart-box">
            <div class="chart-title">Bebidas Mais Pedidas</div>
            <canvas id="drinksChart"></canvas>
          </div>
          <div class="chart-box">
            <div class="chart-title">Sobremesas Mais Pedidas</div>
            <canvas id="dessertsChart"></canvas>
          </div>
          <div class="chart-box">
            <div class="chart-title">Distribuição de Vendas</div>
            <canvas id="salesDistributionChart"></canvas>
          </div>
        </div>

        <div class="export-actions">
          <button class="btn btn-danger" id="exportPdf">
            <i class="fas fa-file-pdf"></i> Exportar PDF
          </button>
        </div>
      </div>
    </div>

    <script>
      // Inicializar jsPDF
      const { jsPDF } = window.jspdf;

      // Dados das mesas (fechadas e com faturas pagas)
      const tables = [
        {
          id: 1,
          name: "Mesa 1",
          status: "closed",
          date: "2023-05-15",
          invoice: {
            number: "F2023-001",
            status: "paid",
            pdfUrl: "#",
            total: 48.5,
          },
          note: "Cliente preferiu não sobremesa",
          order: {
            plates: [
              { name: "Frango Assado", quantity: 2, price: 8.5 },
              { name: "Sopa", quantity: 1, price: 2.5 },
            ],
            extras: [{ name: "Batatas Fritas", quantity: 1, price: 3.0 }],
            drinks: [
              { name: "Água", quantity: 2, price: 1.0 },
              { name: "Vinho", quantity: 1, price: 12.0 },
            ],
            desserts: [{ name: "Bolo", quantity: 1, price: 4.0 }],
            coffee: [{ name: "Expresso", quantity: 2, price: 1.5 }],
          },
        },
        {
          id: 2,
          name: "Mesa 2",
          status: "closed",
          date: "2023-05-15",
          invoice: {
            number: "F2023-002",
            status: "paid",
            pdfUrl: "#",
            total: 16.5,
          },
          note: "",
          order: {
            plates: [{ name: "Peixe Grelhado", quantity: 1, price: 10.5 }],
            extras: [],
            drinks: [{ name: "Cerveja", quantity: 3, price: 2.0 }],
            desserts: [],
            coffee: [],
          },
        },
        {
          id: 3,
          name: "Mesa 3",
          status: "closed",
          date: "2023-05-16",
          invoice: {
            number: "F2023-003",
            status: "paid",
            pdfUrl: "#",
            total: 22.0,
          },
          note: "Pedido para viagem",
          order: {
            plates: [{ name: "Bife", quantity: 1, price: 12.0 }],
            extras: [{ name: "Arroz", quantity: 1, price: 2.0 }],
            drinks: [{ name: "Sumo", quantity: 2, price: 2.5 }],
            desserts: [],
            coffee: [],
          },
        },
        {
          id: 4,
          name: "Mesa 4",
          status: "closed",
          date: "2023-05-16",
          invoice: {
            number: "F2023-004",
            status: "paid",
            pdfUrl: "#",
            total: 89.5,
          },
          note: "Aniversariante - oferta de sobremesa",
          order: {
            plates: [
              { name: "Feijoada", quantity: 2, price: 9.5 },
              { name: "Bacalhau", quantity: 1, price: 13.0 },
            ],
            extras: [{ name: "Legumes Grelhados", quantity: 1, price: 3.5 }],
            drinks: [
              { name: "Vinho Tinto", quantity: 2, price: 12.0 },
              { name: "Água com Gás", quantity: 1, price: 1.5 },
            ],
            desserts: [{ name: "Pudim", quantity: 3, price: 4.0 }],
            coffee: [
              { name: "Cappuccino", quantity: 1, price: 2.5 },
              { name: "Expresso", quantity: 2, price: 1.5 },
            ],
          },
        },
        {
          id: 5,
          name: "Mesa 5",
          status: "closed",
          date: "2023-05-17",
          invoice: {
            number: "F2023-005",
            status: "paid",
            pdfUrl: "#",
            total: 34.0,
          },
          note: "Cliente com restrições alimentares",
          order: {
            plates: [{ name: "Salada", quantity: 2, price: 7.0 }],
            extras: [{ name: "Pão", quantity: 1, price: 2.0 }],
            drinks: [
              { name: "Água", quantity: 2, price: 1.0 },
              { name: "Sumo", quantity: 2, price: 2.5 },
            ],
            desserts: [{ name: "Fruta", quantity: 2, price: 3.0 }],
            coffee: [],
          },
        },
      ];

      // Variáveis para armazenar dados do relatório
      let currentReportData = {
        startDate: "",
        endDate: "",
        totalRevenue: 0,
        totalTables: 0,
        dishes: {},
        drinks: {},
        desserts: {},
        categories: {},
      };

      // Renderizar a lista de mesas
      function renderTables() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const tablesList = document.getElementById("tablesList");

        // Filtrar mesas conforme o termo de pesquisa
        const filteredTables = tables.filter(
          (table) =>
            table.name.toLowerCase().includes(searchTerm) ||
            table.invoice.number.toLowerCase().includes(searchTerm)
        );

        tablesList.innerHTML = "";

        if (filteredTables.length === 0) {
          tablesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>Nenhuma mesa encontrada</p>
                    </div>
                `;
          return;
        }

        filteredTables.forEach((table) => {
          const tableElement = document.createElement("div");
          tableElement.className = "table-item";
          tableElement.innerHTML = `
                    <div class="table-info">
                        <div class="table-name">${table.name}</div>
                        <div class="table-meta">
                            <span class="table-status status-closed">Fechada</span>
                            <span class="table-status invoice-paid">Paga</span>
                            <span>Fatura: ${table.invoice.number}</span>
                            <span>${table.date}</span>
                        </div>
                    </div>
                `;

          tableElement.addEventListener("click", () => {
            // Remover a classe active de todas as mesas
            document.querySelectorAll(".table-item").forEach((item) => {
              item.classList.remove("active");
            });

            // Adicionar a classe active à mesa selecionada
            tableElement.classList.add("active");

            // Mostrar os detalhes da mesa
            renderOrderDetails(table);
          });

          tablesList.appendChild(tableElement);
        });
      }

      // Renderizar os detalhes da mesa selecionada
      function renderOrderDetails(table) {
        const orderDetails = document.getElementById("orderDetails");

        // Função para renderizar uma seção da tabela
        const renderSection = (title, items) => {
          if (!items || items.length === 0) return "";

          let rows = "";
          let total = 0;
          items.forEach((item) => {
            const itemTotal = item.quantity * item.price;
            total += itemTotal;
            rows += `
                        <tr>
                            <td>${item.name}</td>
                            <td>${item.quantity}</td>
                            <td>${item.price.toFixed(2)} €</td>
                            <td>${itemTotal.toFixed(2)} €</td>
                        </tr>
                    `;
          });

          return `
                    <div class="section">
                        <h4>${title} - Total: ${total.toFixed(2)} €</h4>
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantidade</th>
                                    <th>Preço Unit.</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;
        };

        orderDetails.innerHTML = `
                <div class="order-header">
                    <div class="order-title">${table.name}</div>
                    <a href="${
                      table.invoice.pdfUrl
                    }" class="invoice-link" target="_blank">
                        <i class="fas fa-file-pdf"></i> Ver Fatura
                    </a>
                </div>
                
                <div class="section">
                    <h4>Informações da Fatura</h4>
                    <table class="items-table">
                        <tr>
                            <td><strong>Número</strong></td>
                            <td>${table.invoice.number}</td>
                        </tr>
                        <tr>
                            <td><strong>Data</strong></td>
                            <td>${table.date}</td>
                        </tr>
                        <tr>
                            <td><strong>Status</strong></td>
                            <td><span class="table-status invoice-paid">Paga</span></td>
                        </tr>
                        <tr>
                            <td><strong>Total</strong></td>
                            <td>${table.invoice.total.toFixed(2)} €</td>
                        </tr>
                    </table>
                </div>
                
                ${renderSection("Pratos", table.order.plates)}
                ${renderSection("Extras", table.order.extras)}
                ${renderSection("Bebidas", table.order.drinks)}
                ${renderSection("Sobremesas", table.order.desserts)}
                ${renderSection("Cafés", table.order.coffee)}
                
                ${
                  table.note
                    ? `
                    <div class="note-box">
                        <h5>Nota:</h5>
                        <p>${table.note}</p>
                    </div>
                `
                    : ""
                }
            `;
      }

      // Gerar relatório
      function generateReport() {
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;

        if (!startDate || !endDate) {
          alert("Por favor, selecione ambas as datas.");
          return;
        }

        // Filtrar mesas pelo período selecionado
        const filteredTables = tables.filter((table) => {
          const tableDate = new Date(table.date);
          const start = new Date(startDate);
          const end = new Date(endDate);
          end.setHours(23, 59, 59); // Incluir todo o dia final

          return tableDate >= start && tableDate <= end;
        });

        if (filteredTables.length === 0) {
          alert("Nenhuma mesa encontrada no período selecionado.");
          return;
        }

        // Calcular totais
        const totalRevenue = filteredTables.reduce(
          (sum, table) => sum + table.invoice.total,
          0
        );
        document.getElementById(
          "totalRevenue"
        ).textContent = `${totalRevenue.toFixed(2)} €`;
        document.getElementById("totalTables").textContent =
          filteredTables.length;
        document.getElementById(
          "period"
        ).textContent = `${startDate} a ${endDate}`;

        // Calcular pratos mais vendidos
        const dishes = {};
        filteredTables.forEach((table) => {
          table.order.plates.forEach((item) => {
            if (!dishes[item.name]) {
              dishes[item.name] = 0;
            }
            dishes[item.name] += item.quantity;
          });
        });

        // Calcular bebidas mais pedidas
        const drinks = {};
        filteredTables.forEach((table) => {
          table.order.drinks.forEach((item) => {
            if (!drinks[item.name]) {
              drinks[item.name] = 0;
            }
            drinks[item.name] += item.quantity;
          });
        });

        // Calcular sobremesas mais pedidas
        const desserts = {};
        filteredTables.forEach((table) => {
          if (table.order.desserts) {
            table.order.desserts.forEach((item) => {
              if (!desserts[item.name]) {
                desserts[item.name] = 0;
              }
              desserts[item.name] += item.quantity;
            });
          }
        });

        // Calcular distribuição por categoria
        const categories = {
          Pratos: 0,
          Bebidas: 0,
          Sobremesas: 0,
          Extras: 0,
          Cafés: 0,
        };

        filteredTables.forEach((table) => {
          table.order.plates.forEach((item) => {
            categories["Pratos"] += item.quantity * item.price;
          });
          table.order.drinks.forEach((item) => {
            categories["Bebidas"] += item.quantity * item.price;
          });
          if (table.order.desserts) {
            table.order.desserts.forEach((item) => {
              categories["Sobremesas"] += item.quantity * item.price;
            });
          }
          table.order.extras.forEach((item) => {
            categories["Extras"] += item.quantity * item.price;
          });
          if (table.order.coffee) {
            table.order.coffee.forEach((item) => {
              categories["Cafés"] += item.quantity * item.price;
            });
          }
        });

        // Guardar dados para exportação
        currentReportData = {
          startDate,
          endDate,
          totalRevenue,
          totalTables: filteredTables.length,
          dishes,
          drinks,
          desserts,
          categories,
        };

        // Renderizar gráficos
        renderChart(
          "dishesChart",
          Object.keys(dishes),
          Object.values(dishes),
          "Pratos Mais Vendidos"
        );
        renderChart(
          "drinksChart",
          Object.keys(drinks),
          Object.values(drinks),
          "Bebidas Mais Pedidas"
        );
        renderChart(
          "dessertsChart",
          Object.keys(desserts),
          Object.values(desserts),
          "Sobremesas Mais Pedidas"
        );
        renderPieChart(
          "salesDistributionChart",
          Object.keys(categories),
          Object.values(categories),
          "Distribuição de Vendas"
        );
      }

      // Renderizar gráfico de barras
      function renderChart(canvasId, labels, data, title) {
        const ctx = document.getElementById(canvasId).getContext("2d");

        // Destruir gráfico anterior se existir
        if (window[canvasId + "Chart"]) {
          window[canvasId + "Chart"].destroy();
        }

        window[canvasId + "Chart"] = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: title,
                data: data,
                backgroundColor: [
                  "rgba(54, 162, 235, 0.7)",
                  "rgba(75, 192, 192, 0.7)",
                  "rgba(153, 102, 255, 0.7)",
                  "rgba(255, 159, 64, 0.7)",
                  "rgba(255, 99, 132, 0.7)",
                ],
                borderColor: [
                  "rgba(54, 162, 235, 1)",
                  "rgba(75, 192, 192, 1)",
                  "rgba(153, 102, 255, 1)",
                  "rgba(255, 159, 64, 1)",
                  "rgba(255, 99, 132, 1)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false,
              },
              title: {
                display: true,
                text: title,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      // Renderizar gráfico de pizza
      function renderPieChart(canvasId, labels, data, title) {
        const ctx = document.getElementById(canvasId).getContext("2d");

        // Destruir gráfico anterior se existir
        if (window[canvasId + "Chart"]) {
          window[canvasId + "Chart"].destroy();
        }

        window[canvasId + "Chart"] = new Chart(ctx, {
          type: "pie",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: [
                  "rgba(54, 162, 235, 0.7)",
                  "rgba(75, 192, 192, 0.7)",
                  "rgba(153, 102, 255, 0.7)",
                  "rgba(255, 159, 64, 0.7)",
                  "rgba(255, 99, 132, 0.7)",
                ],
                borderColor: [
                  "rgba(54, 162, 235, 1)",
                  "rgba(75, 192, 192, 1)",
                  "rgba(153, 102, 255, 1)",
                  "rgba(255, 159, 64, 1)",
                  "rgba(255, 99, 132, 1)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "bottom",
              },
              title: {
                display: true,
                text: title,
              },
            },
          },
        });
      }

      // Exportar relatório para PDF
      async function exportToPdf() {
        if (currentReportData.totalTables === 0) {
          alert("Gere um relatório primeiro antes de exportar.");
          return;
        }

        // Criar um novo documento PDF
        const doc = new jsPDF("p", "mm", "a4");
        const margin = 15;
        let yPosition = margin;

        // Adicionar cabeçalho
        doc.setFontSize(20);
        doc.setTextColor(44, 62, 80);
        doc.text("Relatório de Vendas", margin, yPosition);
        yPosition += 10;

        doc.setFontSize(12);
        doc.setTextColor(100, 100, 100);
        doc.text(
          `Período: ${currentReportData.startDate} a ${currentReportData.endDate}`,
          margin,
          yPosition
        );
        yPosition += 15;

        // Adicionar resumo
        doc.setFontSize(14);
        doc.setTextColor(44, 62, 80);
        doc.text("Resumo do Período", margin, yPosition);
        yPosition += 8;

        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text(
          `Total Faturado: ${currentReportData.totalRevenue.toFixed(2)} €`,
          margin,
          yPosition
        );
        yPosition += 7;
        doc.text(
          `Número de Mesas: ${currentReportData.totalTables}`,
          margin,
          yPosition
        );
        yPosition += 10;

        // Adicionar gráficos (capturar como imagens)
        const charts = [
          { id: "dishesChart", title: "Pratos Mais Vendidos" },
          { id: "drinksChart", title: "Bebidas Mais Pedidas" },
          { id: "dessertsChart", title: "Sobremesas Mais Pedidas" },
          { id: "salesDistributionChart", title: "Distribuição de Vendas" },
        ];

        for (const chart of charts) {
          // Verificar se há espaço suficiente na página atual
          if (yPosition > 200) {
            doc.addPage();
            yPosition = margin;
          }

          const canvas = document.getElementById(chart.id);
          const chartImage = await html2canvas(canvas);
          const imgData = chartImage.toDataURL("image/png");

          // Adicionar título do gráfico
          doc.setFontSize(12);
          doc.setTextColor(44, 62, 80);
          doc.text(chart.title, margin, yPosition);
          yPosition += 7;

          // Adicionar imagem do gráfico
          const imgWidth = 180;
          const imgHeight = 90;
          doc.addImage(imgData, "PNG", margin, yPosition, imgWidth, imgHeight);
          yPosition += imgHeight + 10;
        }

        // Adicionar tabela de dados
        if (yPosition > 180) {
          doc.addPage();
          yPosition = margin;
        }

        doc.setFontSize(14);
        doc.setTextColor(44, 62, 80);
        doc.text("Detalhamento por Categoria", margin, yPosition);
        yPosition += 10;

        // Adicionar tabela de categorias
        doc.setFontSize(10);
        let tableX = margin;
        let tableY = yPosition;

        // Cabeçalho da tabela
        doc.setFillColor(44, 62, 80);
        doc.setTextColor(255, 255, 255);
        doc.rect(tableX, tableY, 130, 8, "F");
        doc.text("Categoria", tableX + 2, tableY + 5);
        doc.text("Valor (€)", tableX + 100, tableY + 5);

        tableY += 8;
        doc.setTextColor(0, 0, 0);

        // Dados da tabela
        for (const [category, value] of Object.entries(
          currentReportData.categories
        )) {
          if (tableY > 270) {
            doc.addPage();
            tableY = margin;
          }

          doc.text(category, tableX + 2, tableY + 5);
          doc.text(value.toFixed(2), tableX + 100, tableY + 5);
          tableY += 6;
        }

        // Adicionar data de geração no rodapé
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
          doc.setPage(i);
          doc.setFontSize(10);
          doc.setTextColor(100, 100, 100);
          doc.text(
            `Relatório gerado em: ${new Date().toLocaleDateString()}`,
            margin,
            285
          );
          doc.text(`Página ${i} de ${totalPages}`, 180, 285);
        }

        // Salvar o PDF
        doc.save(
          `relatorio_vendas_${currentReportData.startDate}_a_${currentReportData.endDate}.pdf`
        );
      }

      // Inicializar a página
      document.addEventListener("DOMContentLoaded", () => {
        // Definir datas padrão (últimos 7 dias)
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 7);

        document.getElementById("startDate").valueAsDate = startDate;
        document.getElementById("endDate").valueAsDate = endDate;

        // Renderizar as mesas
        renderTables();

        // Adicionar evento de pesquisa
        document
          .getElementById("searchInput")
          .addEventListener("input", renderTables);

        // Botão de relatório
        document.getElementById("reportBtn").addEventListener("click", () => {
          document.getElementById("reportModal").style.display = "flex";
        });

        // Fechar modal
        document.getElementById("closeModal").addEventListener("click", () => {
          document.getElementById("reportModal").style.display = "none";
        });

        // Gerar relatório
        document
          .getElementById("generateReport")
          .addEventListener("click", generateReport);

        // Exportar PDF
        document
          .getElementById("exportPdf")
          .addEventListener("click", exportToPdf);

        // Selecionar a primeira mesa por padrão
        if (tables.length > 0) {
          const firstTable = document.querySelector(".table-item");
          if (firstTable) {
            firstTable.click();
          }
        }

        // Fechar modal ao clicar fora dele
        window.addEventListener("click", (event) => {
          if (event.target === document.getElementById("reportModal")) {
            document.getElementById("reportModal").style.display = "none";
          }
        });
      });
    </script>
  </body>
</html>
