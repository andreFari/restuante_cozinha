<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Gestão de Menu - Moloni</title>
    <link rel="stylesheet" href="css/menu.css" />
    <link rel="stylesheet" href="css/header.css" />
  </head>
  <body>
    <header>
      <div class="logo-title">
        <img src="" alt="Logo" class="logo" />
      </div>
      <div class="links-container">
        <nav id="navLinks">
          <a href="./login.html" class="protected">Receção Bar</a>
          <a href="./rececaoCozi.html" class="protected">Receção Cozinha</a>
          <a href="./cozinha.html" class="protected">Cozinha</a>
          <a href="./faturas.html" class="protected">📄 Ver Faturas</a>
          <a href="./artigos.html" class="protected">🍽️ Gerir Pratos</a>
          <a href="./menu.html" class="protected active">📋 Menu</a>
        </nav>
      </div>
      <div id="tokenDisplay" class="token-status">
        ⚠️ Sistema não autenticado
      </div>
    </header>

    <h1>📋 Gestão de Menus</h1>

    <div class="menu-selector">
      <button class="menu-tab active" data-menu="takeaway">🍱 Takeaway</button>
      <button class="menu-tab" data-menu="bar">🍺 Bar</button>
      <button class="menu-tab" data-menu="esplanada">🌞 Esplanada</button>
      <button class="menu-tab" data-menu="restaurante">🍽️ Restaurante</button>
    </div>

    <div class="menu-container">
      <div class="list">
        <h2>🍳 Todos os Pratos</h2>
        <div class="category-selector">
          <button class="category-tab active" data-category="all">Todas</button>
          <button class="category-tab" data-category="Prato">Pratos</button>
          <button class="category-tab" data-category="Sopa">Sopas</button>
          <button class="category-tab" data-category="Bebida">Bebidas</button>
        </div>

        <table id="allDishes">
          <thead>
            <tr>
              <th>Selecionar</th>
              <th>Nome</th>
              <th>Preço</th>
              <th>Categoria</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="list">
        <h2>✅ No Menu <span id="currentMenuName">Takeaway</span></h2>
        <table id="menuDishes">
          <thead>
            <tr>
              <th>Selecionar</th>
              <th>Nome</th>
              <th>Preço</th>
              <th>Categoria</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        let menus = {
          takeaway: [],
          bar: [],
          esplanada: [],
          restaurante: [],
        };

        let pratos = [
          {
            product_id: 1,
            name: "Bife à Portuguesa",
            price: 12.5,
            category: "Prato",
          },
          {
            product_id: 2,
            name: "Bacalhau à Brás",
            price: 10.0,
            category: "Prato",
          },
          {
            product_id: 3,
            name: "Sopa de Legumes",
            price: 3.5,
            category: "Sopa",
          },
          {
            product_id: 4,
            name: "Francesinha",
            price: 11.0,
            category: "Prato",
          },
          {
            product_id: 5,
            name: "Vinho Tinto",
            price: 5.0,
            category: "Bebida",
          },
          {
            product_id: 6,
            name: "Água Mineral",
            price: 1.5,
            category: "Bebida",
          },
        ];

        let currentMenu = "takeaway";
        let currentCategory = "all";

        const allBody = document.querySelector("#allDishes tbody");
        const menuBody = document.querySelector("#menuDishes tbody");
        const menuName = document.getElementById("currentMenuName");
        // Delegação de evento para todos os pratos
        allBody.addEventListener("change", (e) => {
          if (e.target.tagName === "INPUT") {
            const row = e.target.closest("tr");
            const id = parseInt(row.dataset.id);
            const prato = pratos.find((p) => p.product_id === id);

            if (e.target.checked) {
              if (!menus[currentMenu].some((m) => m.product_id === id)) {
                menus[currentMenu].push(prato);
              }
            } else {
              menus[currentMenu] = menus[currentMenu].filter(
                (m) => m.product_id !== id
              );
            }

            renderMenuDishes();
          }
        });
        function renderAllDishes() {
          allBody.innerHTML = "";

          pratos
            .filter(
              (p) => currentCategory === "all" || p.category === currentCategory
            )
            .forEach((p) => {
              const row = document.createElement("tr");
              row.dataset.id = p.product_id;

              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.checked = menus[currentMenu].some(
                (m) => m.product_id === p.product_id
              );

              const tdCheck = document.createElement("td");
              tdCheck.appendChild(checkbox);

              const tdName = document.createElement("td");
              tdName.textContent = p.name;

              const tdPrice = document.createElement("td");
              tdPrice.textContent = p.price.toFixed(2) + " €";

              const tdCategory = document.createElement("td");
              tdCategory.textContent = p.category;

              row.append(tdCheck, tdName, tdPrice, tdCategory);

              // Aqui: adicionamos clique na linha inteira
              row.addEventListener("click", (e) => {
                // Evita que clicar diretamente na checkbox dispare duas vezes
                if (e.target.tagName !== "INPUT") {
                  checkbox.checked = !checkbox.checked;
                }

                if (checkbox.checked) {
                  if (
                    !menus[currentMenu].some(
                      (m) => m.product_id === p.product_id
                    )
                  ) {
                    menus[currentMenu].push(p);
                  }
                } else {
                  menus[currentMenu] = menus[currentMenu].filter(
                    (m) => m.product_id !== p.product_id
                  );
                }
                renderMenuDishes();
              });

              allBody.appendChild(row);
            });
        }

        function updateAllDishesCheckboxes() {
          Array.from(allBody.querySelectorAll("tr")).forEach((row) => {
            const id = parseInt(row.dataset.id);
            const checkbox = row.querySelector("input");
            checkbox.checked = menus[currentMenu].some(
              (m) => m.product_id === id
            );
          });
        }

        function renderMenuDishes() {
          menuBody.innerHTML = "";
          menus[currentMenu].forEach((p) => {
            const row = document.createElement("tr");
            row.dataset.id = p.product_id;
            row.innerHTML = `
      <td><input type="checkbox" checked></td>
      <td>${p.name}</td>
      <td>${p.price.toFixed(2)} €</td>
      <td>${p.category}</td>
    `;
            menuBody.appendChild(row);

            row.querySelector("input").addEventListener("change", () => {
              menus[currentMenu] = menus[currentMenu].filter(
                (m) => m.product_id !== p.product_id
              );
              renderMenuDishes();
              updateAllDishesCheckboxes();
            });
          });
        }
        function render() {
          menuName.textContent =
            currentMenu.charAt(0).toUpperCase() + currentMenu.slice(1);
          renderAllDishes();
          renderMenuDishes();
        }

        // Inicialização
        render();

        // Alternar menu
        document.querySelectorAll(".menu-tab").forEach((btn) => {
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".menu-tab")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            currentMenu = btn.dataset.menu;
            render();
          });
        });

        // Alternar categoria
        document.querySelectorAll(".category-tab").forEach((btn) => {
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".category-tab")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            currentCategory = btn.dataset.category;
            renderAllDishes();
          });
        });
      });
    </script>

    <script src="./js/header.js"></script>
  </body>
</html>
