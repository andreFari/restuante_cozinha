<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Criar Guia de Transporte</title>
    <link rel="stylesheet" href="css/header.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background-color: #f7f8fa;
        color: #333;
        padding: 20px;
      }
      h1 {
        text-align: center;
        color: #34495e;
        margin-bottom: 2rem;
        margin-top: 2rem;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }
      .top-bar {
        display: flex;
        flex-direction: column; /* coloca os elementos em coluna */
        align-items: center; /* centraliza horizontalmente */
        margin-bottom: 2rem;
        gap: 1rem; /* espa√ßamento entre t√≠tulo e bot√£o */
      }

      .top-bar button {
        background: #27ae60;
        color: white;
        padding: 0.6rem 1rem;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s;
      }

      .top-bar button:hover {
        background: #1e8449;
      }
      .section {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        display: grid;
        gap: 1rem 1.5rem;
      }

      .section h3 {
        grid-column: 1 / -1;
        border-bottom: 2px solid #eee;
        padding-bottom: 0.5rem;
        margin-bottom: 0.5rem;
      }

      label {
        font-weight: bold;
        margin-bottom: 0.3rem;
        display: block;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 0.5rem;
        border-radius: 4px;
        border: 1px solid #ccc;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem 1.5rem;
      }

      .full-width {
        grid-column: 1 / -1;
      }

      button {
        background: #2980b9;
        color: white;
        padding: 0.8rem;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }
      #submit {
        background: #2980b9;
        color: white;
        padding: 0.8rem;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
        margin-bottom: 5%;
      }
      #submit:hover {
        background: #1f5e85;
      }
      button:hover {
        background: #1f5e85;
      }

      .actions {
        display: flex;
        gap: 1rem;
      }

      @media (max-width: 800px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
        .actions {
          flex-direction: column;
        }
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        max-width: 800px;
        width: 90%;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .modal-body {
        overflow-y: auto;
        flex: 1;
        display: grid;
        gap: 0.5rem;
      }

      .artigo-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        padding: 0.8rem 1rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f9f9f9;
        transition: background 0.2s;
      }
      .artigo-item input[type="checkbox"] {
        width: 22px;
        height: 22px;
        cursor: pointer;
      }

      .artigo-item label {
        flex: 1;
        font-size: 1rem;
        font-weight: 500;
        text-align: left;
      }

      .artigo-item .quantidade {
        width: 60px;
        text-align: center;
        padding: 0.3rem;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      .artigo-item:hover {
        background: #eef6fc;
      }
      #verGuias {
        margin-bottom: 2%;
      }
      .search-input {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 100%;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <div id="header-placeholder"></div>
    <div>
      <div class="top-bar">
        <h1>üöö Criar Guia de Transporte</h1>
        <button
          type="button"
          id="verGuias"
          onclick="window.location.href='listar-guias.html'"
        >
          üìã Ver Guias
        </button>
      </div>
      <form id="guiaForm">
        <div class="section grid-2">
          <label for="cliente">Cliente:</label>
          <select id="cliente" required></select>

          <label>Artigos:</label>
          <div class="actions full-width">
            <button type="button" id="openArtigosModal">
              ‚ûï Selecionar Artigos
            </button>
            <span id="artigosResumo">Nenhum artigo selecionado</span>
          </div>

          <label for="deliveryMethod">M√©todo de Entrega:</label>
          <select id="deliveryMethod" required></select>

          <label for="viatura">Viaturas:</label>
          <select id="viatura" required></select>

          <label for="emissao">Data de emiss√£o:</label>
          <input type="datetime-local" id="emissao" required />

          <label for="inicio">In√≠cio do transporte:</label>
          <input type="datetime-local" id="inicio" required />
        </div>

        <div class="section">
          <h3>Local de Carga (Empresa)</h3>
          <label>Morada:</label>
          <input type="text" id="moradaCarga" required />
          <label>C√≥digo Postal:</label>
          <input type="text" id="cpCarga" required />
          <label>Localidade:</label>
          <input type="text" id="localCarga" required />
          <label>Pa√≠s:</label>
          <input type="text" id="paisCarga" value="Portugal" required />
        </div>

        <div class="section">
          <h3>Local de Descarga (Cliente)</h3>
          <label>Morada:</label>
          <input type="text" id="moradaDescarga" required />
          <label>C√≥digo Postal:</label>
          <input type="text" id="cpDescarga" required />
          <label>Localidade:</label>
          <input type="text" id="localDescarga" required />
          <label>Pa√≠s:</label>
          <input type="text" id="paisDescarga" value="Portugal" required />
        </div>

        <div class="section">
          <label for="obs">Observa√ß√µes:</label>
          <textarea id="obs" class="full-width" rows="4"></textarea>
        </div>

        <button type="submit" id="submit">Criar Guia</button>
      </form>

      <!-- Modal -->
      <div id="artigosModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Selecionar Artigos</h2>
            <button id="closeArtigosModal">‚úñ</button>
          </div>
          <input
            type="text"
            id="searchArtigos"
            class="search-input"
            placeholder="Pesquisar artigos..."
          />
          <div class="modal-body" id="artigosLista"></div>
          <div
            class="actions"
            style="margin-top: 1rem; justify-content: flex-end"
          >
            <button type="button" id="confirmArtigos">Confirmar Sele√ß√£o</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      let artigosData = [];
      let artigosSelecionados = [];

      document.addEventListener("DOMContentLoaded", async () => {
        const now = new Date().toISOString().slice(0, 16);
        document.getElementById("emissao").value = now;
        document.getElementById("inicio").value = now;

        await preencherClientes();
        await preencherViaturas();
        await preencherDeliveryMethods();
      });

      document
        .getElementById("openArtigosModal")
        .addEventListener("click", async () => {
          document.getElementById("artigosModal").style.display = "flex";
          if (artigosData.length === 0) await carregarArtigos();
        });

      document
        .getElementById("closeArtigosModal")
        .addEventListener("click", () => {
          document.getElementById("artigosModal").style.display = "none";
        });

      document
        .getElementById("searchArtigos")
        .addEventListener("input", (e) => {
          renderArtigos(e.target.value.toLowerCase());
        });

      document
        .getElementById("confirmArtigos")
        .addEventListener("click", () => {
          artigosSelecionados = Array.from(
            document.querySelectorAll(
              ".artigo-item input[type=checkbox]:checked"
            )
          ).map((cb) => {
            const id = cb.value;
            const qtd =
              cb.parentElement.querySelector(".quantidade").value || 1;
            return { artigoId: id, quantidade: parseFloat(qtd) };
          });
          document.getElementById("artigosResumo").textContent =
            artigosSelecionados.length > 0
              ? `${artigosSelecionados.length} artigo(s) selecionado(s)`
              : "Nenhum artigo selecionado";
          document.getElementById("artigosModal").style.display = "none";
        });

      async function preencherClientes() {
        const res = await fetch("/molo/api/moloni-customers");
        const clientes = await res.json();
        const select = document.getElementById("cliente");
        clientes.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = `${c.nome} (${c.nif})`;
          select.appendChild(opt);
        });
      }

      async function preencherViaturas() {
        const res = await fetch("/molo/api/viaturas");
        const viaturas = await res.json();
        const select = document.getElementById("viatura");
        viaturas.forEach((v) => {
          const opt = document.createElement("option");
          opt.value = v.id;
          opt.textContent = v.matricula;
          select.appendChild(opt);
        });
      }

      async function preencherDeliveryMethods() {
        const res = await fetch("/molo/api/delivery-methods");
        const methods = await res.json();
        const select = document.getElementById("deliveryMethod");
        methods.forEach((m) => {
          const opt = document.createElement("option");
          opt.value = m.id;
          opt.textContent = m.name;
          select.appendChild(opt);
        });
      }

      async function carregarArtigos() {
        const res = await fetch("/molo/api/artigos");
        artigosData = await res.json();
        renderArtigos();
      }

      function renderArtigos(filtro = "") {
        const lista = document.getElementById("artigosLista");
        lista.innerHTML = "";
        artigosData
          .filter((a) => a.nome.toLowerCase().includes(filtro))
          .forEach((a) => {
            const div = document.createElement("div");
            div.className = "artigo-item";
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = a.id;
            const label = document.createElement("label");
            label.textContent = `${a.nome} - ${a.preco}‚Ç¨`;
            const quantidade = document.createElement("input");
            quantidade.type = "number";
            quantidade.min = "1";
            quantidade.value = "1";
            quantidade.className = "quantidade";
            quantidade.style.width = "60px";
            div.append(checkbox, label, quantidade);
            lista.appendChild(div);
          });
      }

      document
        .getElementById("guiaForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const dados = {
            clienteId: document.getElementById("cliente").value,
            artigos: artigosSelecionados,
            viaturaId: document.getElementById("viatura").value,
            emissao: document.getElementById("emissao").value.split("T")[0],
            inicio: document.getElementById("inicio").value.split("T")[0],
            carga: {
              morada: document.getElementById("moradaCarga").value,
              cp: document.getElementById("cpCarga").value,
              localidade: document.getElementById("localCarga").value,
              pais: document.getElementById("paisCarga").value,
            },
            deliveryMethodId: document.getElementById("deliveryMethod").value,
            descarga: {
              morada: document.getElementById("moradaDescarga").value,
              cp: document.getElementById("cpDescarga").value,
              localidade: document.getElementById("localDescarga").value,
              pais: document.getElementById("paisDescarga").value,
            },
            observacoes: document.getElementById("obs").value,
          };

          const res = await fetch("/molo/api/guias", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dados),
          });

          if (res.ok) {
            alert("Guia criada com sucesso!");
            document.getElementById("guiaForm").reset();
            artigosSelecionados = [];
            document.getElementById("artigosResumo").textContent =
              "Nenhum artigo selecionado";
          } else {
            const erro = await res.json();
            alert("Erro: " + (erro.detalhe || "Erro desconhecido"));
          }
        });
    </script>
    <script src="./js/header.js"></script>
  </body>
</html>
