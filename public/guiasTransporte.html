<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Criar Guia de Transporte</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: auto;
        padding: 2rem;
        background: #f5f5f5;
      }

      h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 2rem;
      }

      label {
        display: block;
        margin-top: 1rem;
        font-weight: bold;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 0.5rem;
        margin-top: 0.3rem;
        border-radius: 4px;
        border: 1px solid #ccc;
      }

      .section {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
      }

      button {
        background: #2980b9;
        color: white;
        padding: 0.8rem;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        width: 100%;
        cursor: pointer;
        margin-top: 1.5rem;
      }

      button:hover {
        background: #1f5e85;
      }
    </style>
  </head>
  <body>
    <h1>üöö Criar Guia de Transporte</h1>

    <form id="guiaForm">
      <div class="section">
        <label for="cliente">Cliente:</label>
        <select id="cliente" required></select>

        <label for="artigos">Artigos:</label>
        <select id="artigos" multiple required></select>
        <label for="deliveryMethod">M√©todo de Entrega:</label>
        <select id="deliveryMethod" required></select>
        <label for="viatura">Viaturas:</label>
        <select id="viatura" required></select>

        <label for="emissao">Data de emiss√£o:</label>
        <input type="datetime-local" id="emissao" required />

        <label for="inicio">In√≠cio do transporte:</label>
        <input type="datetime-local" id="inicio" required />
      </div>

      <div class="section">
        <h3>Local de Carga (Empresa)</h3>
        <label>Morada:</label>
        <input type="text" id="moradaCarga" required />
        <label>C√≥digo Postal:</label>
        <input type="text" id="cpCarga" required />
        <label>Localidade:</label>
        <input type="text" id="localCarga" required />
        <label>Pa√≠s:</label>
        <input type="text" id="paisCarga" value="Portugal" required />
      </div>

      <div class="section">
        <h3>Local de Descarga (Cliente)</h3>
        <label>Morada:</label>
        <input type="text" id="moradaDescarga" required />
        <label>C√≥digo Postal:</label>
        <input type="text" id="cpDescarga" required />
        <label>Localidade:</label>
        <input type="text" id="localDescarga" required />
        <label>Pa√≠s:</label>
        <input type="text" id="paisDescarga" value="Portugal" required />
      </div>

      <div class="section">
        <label for="obs">Observa√ß√µes:</label>
        <textarea id="obs" rows="4"></textarea>
      </div>

      <button type="submit">Criar Guia</button>
    </form>
    <button type="button" onclick="window.location.href='listar-guias.html'">
      üìã Ver Guias
    </button>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        // Preencher campos com data atual
        const now = new Date().toISOString().slice(0, 16);
        document.getElementById("emissao").value = now;
        document.getElementById("inicio").value = now;

        // Preencher dropdowns
        await preencherClientes();
        await preencherArtigos();
        await preencherViaturas();
        await preencherDeliveryMethods();
      });

      async function preencherClientes() {
        const res = await fetch("/molo/api/moloni-customers");
        const clientes = await res.json();
        const select = document.getElementById("cliente");
        clientes.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = `${c.nome} (${c.nif})`;
          select.appendChild(opt);
        });
      }
      const artigosSelecionados = Array.from(
        document.querySelectorAll("#artigosContainer .artigo-item")
      )
        .filter((div) => div.querySelector("input[type=checkbox]").checked)
        .map((div) => ({
          artigoId: div.querySelector("input[type=checkbox]").value,
          quantidade: parseFloat(div.querySelector(".quantidade").value) || 1,
        }));
      async function preencherArtigos() {
        const res = await fetch("/molo/api/artigos");
        const artigos = await res.json();
        const container = document.getElementById("artigosContainer");
        container.innerHTML = ""; // Limpar

        artigos.forEach((a) => {
          const div = document.createElement("div");
          div.classList.add("artigo-item");

          div.innerHTML = `
      <input type="checkbox" id="artigo-${a.id}" value="${a.id}" />
      <label for="artigo-${a.id}">${a.nome} - ${a.preco}‚Ç¨</label>
      <input type="number" min="1" value="1" class="quantidade" style="width: 60px;" />
    `;
          container.appendChild(div);
        });
      }

      async function preencherViaturas() {
        const res = await fetch("/molo/api/viaturas");
        if (!res.ok) {
          console.error("Failed to fetch viaturas", res.status);
          return;
        }
        const viaturas = await res.json();

        if (!Array.isArray(viaturas)) {
          console.error("Erro: viaturas n√£o √© um array", viaturas);
          return;
        }

        const select = document.getElementById("viatura");
        viaturas.forEach((v) => {
          const opt = document.createElement("option");
          opt.value = v.id;
          opt.textContent = v.matricula;
          select.appendChild(opt);
        });
      }

      document
        .getElementById("guiaForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const emissaoISO = document.getElementById("emissao").value; // ex: "2025-08-08T14:30"
          const inicioISO = document.getElementById("inicio").value;

          const emissao = emissaoISO.split("T")[0]; // "2025-08-08"
          const inicio = inicioISO.split("T")[0]; // "2025-08-08"
          const dados = {
            clienteId: document.getElementById("cliente").value,
            artigos: artigosSelecionados,
            viaturaId: document.getElementById("viatura").value,
            emissao, // j√° s√≥ data YYYY-MM-DD
            inicio,
            carga: {
              morada: document.getElementById("moradaCarga").value,
              cp: document.getElementById("cpCarga").value,
              localidade: document.getElementById("localCarga").value,
              pais: document.getElementById("paisCarga").value,
            },
            deliveryMethodId: document.getElementById("deliveryMethod").value,
            descarga: {
              morada: document.getElementById("moradaDescarga").value,
              cp: document.getElementById("cpDescarga").value,
              localidade: document.getElementById("localDescarga").value,
              pais: document.getElementById("paisDescarga").value,
            },
            observacoes: document.getElementById("obs").value,
          };

          try {
            const res = await fetch("/molo/api/guias", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(dados),
            });

            if (!res.ok) {
              const result = await res.json();
              throw new Error(result.detalhe || "Erro desconhecido");
            }

            alert("Guia criada com sucesso!");
            document.getElementById("guiaForm").reset();
          } catch (err) {
            alert("Erro ao criar guia: " + err.message);
          }
        });
      async function preencherDeliveryMethods() {
        try {
          const res = await fetch("/molo/api/delivery-methods");
          if (!res.ok) throw new Error("Erro ao carregar m√©todos de entrega");
          const methods = await res.json();

          const select = document.getElementById("deliveryMethod");
          select.innerHTML = ""; // Limpar se necess√°rio

          methods.forEach((m) => {
            const opt = document.createElement("option");
            opt.value = m.id;
            opt.textContent = m.name;
            select.appendChild(opt);
          });
        } catch (err) {
          console.error("Erro ao carregar m√©todos de entrega:", err);
          alert("Erro ao carregar m√©todos de entrega. Ver consola.");
        }
      }
    </script>
  </body>
</html>
