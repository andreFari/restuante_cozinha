<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Criar Guia de Transporte</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1100px;
        margin: auto;
        padding: 2rem;
        background: #f8f9fa;
        color: #2c3e50;
      }

      h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 2rem;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      .section {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        display: grid;
        gap: 1rem 1.5rem;
      }

      .section h3 {
        grid-column: 1 / -1;
        border-bottom: 2px solid #eee;
        padding-bottom: 0.5rem;
        margin-bottom: 0.5rem;
      }

      label {
        font-weight: bold;
      }

      input:required,
      select:required,
      textarea:required {
        border-left: 3px solid #e67e22;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 0.5rem;
        border-radius: 4px;
        border: 1px solid #ccc;
      }

      .grid-2 {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }

      .grid-3 {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      #artigosContainer {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 0.8rem;
      }

      .artigo-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #fdfdfd;
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid #ddd;
      }

      button {
        background: #2980b9;
        color: white;
        padding: 0.8rem;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }

      button:hover {
        background: #1f5e85;
      }

      .actions {
        display: flex;
        gap: 1rem;
      }

      @media (max-width: 600px) {
        .actions {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <h1>üöö Criar Guia de Transporte</h1>

    <form id="guiaForm">
      <div class="section grid-2">
        <label for="cliente">Cliente:</label>
        <select id="cliente" required></select>

        <label>Artigos:</label>
        <div id="artigosContainer"></div>
        <label for="deliveryMethod">M√©todo de Entrega:</label>
        <select id="deliveryMethod" required></select>
        <label for="viatura">Viaturas:</label>
        <select id="viatura" required></select>

        <label for="emissao">Data de emiss√£o:</label>
        <input type="datetime-local" id="emissao" required />

        <label for="inicio">In√≠cio do transporte:</label>
        <input type="datetime-local" id="inicio" required />
      </div>

      <div class="section">
        <h3>Local de Carga (Empresa)</h3>
        <label>Morada:</label>
        <input type="text" id="moradaCarga" required />
        <label>C√≥digo Postal:</label>
        <input type="text" id="cpCarga" required />
        <label>Localidade:</label>
        <input type="text" id="localCarga" required />
        <label>Pa√≠s:</label>
        <input type="text" id="paisCarga" value="Portugal" required />
      </div>

      <div class="section">
        <h3>Local de Descarga (Cliente)</h3>
        <label>Morada:</label>
        <input type="text" id="moradaDescarga" required />
        <label>C√≥digo Postal:</label>
        <input type="text" id="cpDescarga" required />
        <label>Localidade:</label>
        <input type="text" id="localDescarga" required />
        <label>Pa√≠s:</label>
        <input type="text" id="paisDescarga" value="Portugal" required />
      </div>

      <div class="section">
        <label for="obs">Observa√ß√µes:</label>
        <textarea id="obs" rows="4"></textarea>
      </div>

      <button type="submit">Criar Guia</button>
    </form>
    <button type="button" onclick="window.location.href='listar-guias.html'">
      üìã Ver Guias
    </button>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        // Preencher campos com data atual
        const now = new Date().toISOString().slice(0, 16);
        document.getElementById("emissao").value = now;
        document.getElementById("inicio").value = now;

        // Preencher dropdowns
        await preencherClientes();
        await preencherArtigos();
        await preencherViaturas();
        await preencherDeliveryMethods();
      });

      async function preencherClientes() {
        const res = await fetch("/molo/api/moloni-customers");
        const clientes = await res.json();
        const select = document.getElementById("cliente");
        clientes.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = `${c.nome} (${c.nif})`;
          select.appendChild(opt);
        });
      }

      async function preencherArtigos() {
        const res = await fetch("/molo/api/artigos");
        const artigos = await res.json();
        const container = document.getElementById("artigosContainer");
        container.innerHTML = "";

        artigos.forEach((a) => {
          const div = document.createElement("div");
          div.classList.add("artigo-item");
          div.style.display = "flex";
          div.style.alignItems = "center";
          div.style.gap = "0.5rem";
          div.style.marginBottom = "0.5rem";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `artigo-${a.id}`;
          checkbox.value = a.id;

          const label = document.createElement("label");
          label.htmlFor = `artigo-${a.id}`;
          label.textContent = `${a.nome} - ${a.preco}‚Ç¨`;

          const quantidade = document.createElement("input");
          quantidade.type = "number";
          quantidade.min = "1";
          quantidade.value = "1";
          quantidade.classList.add("quantidade");
          quantidade.style.width = "60px";
          quantidade.disabled = true;

          // Habilitar quantidade s√≥ quando artigo for selecionado
          checkbox.addEventListener("change", () => {
            quantidade.disabled = !checkbox.checked;
          });

          div.appendChild(checkbox);
          div.appendChild(label);
          div.appendChild(quantidade);

          container.appendChild(div);
        });
      }
      async function preencherViaturas() {
        const res = await fetch("/molo/api/viaturas");
        if (!res.ok) {
          console.error("Failed to fetch viaturas", res.status);
          return;
        }
        const viaturas = await res.json();

        if (!Array.isArray(viaturas)) {
          console.error("Erro: viaturas n√£o √© um array", viaturas);
          return;
        }

        const select = document.getElementById("viatura");
        viaturas.forEach((v) => {
          const opt = document.createElement("option");
          opt.value = v.id;
          opt.textContent = v.matricula;
          select.appendChild(opt);
        });
      }

      document
        .getElementById("guiaForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const submitBtn = e.target.querySelector("button[type=submit]");
          submitBtn.disabled = true;
          submitBtn.textContent = "A criar...";
          // Pegar artigos selecionados no momento do submit
          const artigosSelecionados = Array.from(
            document.querySelectorAll("#artigosContainer .artigo-item")
          )
            .filter((div) => div.querySelector("input[type=checkbox]").checked)
            .map((div) => ({
              artigoId: div.querySelector("input[type=checkbox]").value,
              quantidade:
                parseFloat(div.querySelector(".quantidade").value) || 1,
            }));

          const emissaoISO = document.getElementById("emissao").value;
          const inicioISO = document.getElementById("inicio").value;

          const dados = {
            clienteId: document.getElementById("cliente").value,
            artigos: artigosSelecionados,
            viaturaId: document.getElementById("viatura").value,
            emissao: emissaoISO.split("T")[0],
            inicio: inicioISO.split("T")[0],
            carga: {
              morada: document.getElementById("moradaCarga").value,
              cp: document.getElementById("cpCarga").value,
              localidade: document.getElementById("localCarga").value,
              pais: document.getElementById("paisCarga").value,
            },
            deliveryMethodId: document.getElementById("deliveryMethod").value,
            descarga: {
              morada: document.getElementById("moradaDescarga").value,
              cp: document.getElementById("cpDescarga").value,
              localidade: document.getElementById("localDescarga").value,
              pais: document.getElementById("paisDescarga").value,
            },
            observacoes: document.getElementById("obs").value,
          };

          try {
            const res = await fetch("/molo/api/guias", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(dados),
            });

            if (!res.ok) {
              const result = await res.json();
              throw new Error(result.detalhe || "Erro desconhecido");
            }

            alert("Guia criada com sucesso!");
            document.getElementById("guiaForm").reset();
          } catch (err) {
            alert("Erro ao criar guia: " + err.message);
          }

          submitBtn.disabled = false;
          submitBtn.textContent = "Criar Guia";
        });
      async function preencherDeliveryMethods() {
        try {
          const res = await fetch("/molo/api/delivery-methods");
          if (!res.ok) throw new Error("Erro ao carregar m√©todos de entrega");
          const methods = await res.json();

          const select = document.getElementById("deliveryMethod");
          select.innerHTML = ""; // Limpar se necess√°rio

          methods.forEach((m) => {
            const opt = document.createElement("option");
            opt.value = m.id;
            opt.textContent = m.name;
            select.appendChild(opt);
          });
        } catch (err) {
          console.error("Erro ao carregar m√©todos de entrega:", err);
          alert("Erro ao carregar m√©todos de entrega. Ver consola.");
        }
      }
    </script>
  </body>
</html>
