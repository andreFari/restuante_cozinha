<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Guias de Transporte</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: auto;
        padding: 2rem;
        background: #f9f9f9;
      }

      h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 2rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      th,
      td {
        padding: 1rem;
        border: 1px solid #ddd;
        text-align: left;
      }

      th {
        background: #2980b9;
        color: white;
      }

      tr:nth-child(even) {
        background: #f2f2f2;
      }

      .empty {
        text-align: center;
        padding: 2rem;
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
        border-radius: 4px;
      }

      button {
        background: #2980b9;
        color: white;
        border: none;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background: #1f5e85;
      }
    </style>
  </head>
  <body>
    <h1>ðŸ“„ Guias de Transporte</h1>

    <div id="tabelaGuias"></div>

    <script>
      async function carregarGuias() {
        const container = document.getElementById("tabelaGuias");
        container.innerHTML = ""; // limpar conteÃºdo

        try {
          const res = await fetch("/molo/importar/guias");
          const guias = await res.json();

          if (!Array.isArray(guias) || guias.length === 0) {
            container.innerHTML =
              '<div class="empty">Nenhuma guia encontrada.</div>';
            return;
          }

          const tabela = document.createElement("table");
          tabela.innerHTML = `
            <thead>
              <tr>
                <th>NÂº</th>
                <th>Data</th>
                <th>Cliente</th>
                <th>NIF</th>
                <th>Total LÃ­quido</th>
                <th>CÃ³digo AT</th>
                <th>AÃ§Ãµes</th>
              </tr>
            </thead>
            <tbody>
              ${guias
                .map(
                  (g) => `
                <tr>
                  <td>${g.numero || "-"}</td>
                  <td>${new Date(g.data).toLocaleString("pt-PT")}</td>
                  <td>${g.cliente || "-"}</td>
                  <td>${g.nif || "-"}</td>
                  <td>${parseFloat(g.total || 0).toFixed(2)} â‚¬</td>
                  <td>${g.codigoAT || "-"}</td>
                  <td><button data-numero="${
                    g.numero
                  }">Alterar CÃ³digo</button></td>
                </tr>
              `
                )
                .join("")}
            </tbody>
          `;

          container.appendChild(tabela);

          // Adicionar event listener aos botÃµes
          container.querySelectorAll("button").forEach((btn) => {
            btn.addEventListener("click", () => {
              const numero = btn.getAttribute("data-numero");
              definirCodigoAT(numero);
            });
          });
        } catch (err) {
          container.innerHTML =
            '<div class="empty">Erro ao carregar guias.</div>';
          console.error("Erro ao carregar guias:", err);
        }
      }

      async function definirCodigoAT(numero) {
        const codigo = prompt(
          `Introduz o novo cÃ³digo AT para a guia nÂº ${numero}`
        );
        if (!codigo) return;

        try {
          const res = await fetch(`/molo/api/guias/${numero}/codigo-at`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ transport_code: codigo }),
          });

          const result = await res.json();

          if (!res.ok) throw new Error(result.detalhe || "Erro desconhecido");

          alert("CÃ³digo AT atualizado com sucesso!");
          carregarGuias(); // Atualiza a lista apÃ³s mudanÃ§a
        } catch (err) {
          alert("Erro ao atualizar cÃ³digo AT: " + err.message);
        }
      }

      document.addEventListener("DOMContentLoaded", carregarGuias);
    </script>
  </body>
</html>
