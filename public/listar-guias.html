<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Guias de Transporte</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: auto;
        padding: 2rem;
        background: #f9f9f9;
      }

      h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 2rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      th,
      td {
        padding: 1rem;
        border: 1px solid #ddd;
        text-align: left;
      }

      th {
        background: #2980b9;
        color: white;
      }

      tr:nth-child(even) {
        background: #f2f2f2;
      }

      .empty {
        text-align: center;
        padding: 2rem;
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
        border-radius: 4px;
      }

      button {
        background: #2980b9;
        color: white;
        border: none;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background: #1f5e85;
      }
    </style>
  </head>
  <body>
    <h1>üìÑ Guias de Transporte</h1>

    <div id="tabelaGuias"></div>

    <script>
      async function carregarGuias() {
        const container = document.getElementById("tabelaGuias");
        container.innerHTML = ""; // limpar conte√∫do

        try {
          const res = await fetch("/molo/importar/guias");
          const guias = await res.json();

          if (!Array.isArray(guias) || guias.length === 0) {
            container.innerHTML =
              '<div class="empty">Nenhuma guia encontrada.</div>';
            return;
          }

          const tabela = document.createElement("table");
          tabela.innerHTML = `
            <thead>
              <tr>
                <th>N¬∫</th>
                <th>Data</th>
                <th>Cliente</th>
                <th>NIF</th>
                <th>Total L√≠quido</th>
                <th>C√≥digo AT</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              ${guias
                .map(
                  (g) => `
                <tr>
                  <td>${g.numero || "-"}</td>
                  <td>${new Date(g.data).toLocaleString("pt-PT")}</td>
                  <td>${g.cliente || "-"}</td>
                  <td>${g.nif || "-"}</td>
                  <td>${parseFloat(g.total || 0).toFixed(2)} ‚Ç¨</td>
                  <td>${g.codigoAT || "-"}</td>
                  <td><button  class="alterar" data-id="${
                    g.id
                  }">Alterar C√≥digo</button></td>
                 
                </tr>
              `
                )
                .join("")}
            </tbody>
          `;

          container.appendChild(tabela);

          // Adicionar event listener aos bot√µes
          container.querySelectorAll("button.alterar").forEach((btn) => {
            btn.addEventListener("click", () => {
              const id = btn.getAttribute("data-id");
              definirCodigoAT(id);
            });
          });

          container.querySelectorAll("button.atualizar").forEach((btn) => {
            btn.addEventListener("click", () => {
              const id = btn.getAttribute("data-id");
              atualizarCodigoAT(id);
            });
          });
        } catch (err) {
          container.innerHTML =
            '<div class="empty">Erro ao carregar guias.</div>';
          console.error("Erro ao carregar guias:", err);
        }
      }
      async function atualizarCodigoAT(document_id) {
        try {
          const res = await fetch(`/molo/api/guias/${document_id}/refresh-at`);
          const data = await res.json();

          if (!data || !data.at_code) {
            alert("C√≥digo AT ainda n√£o dispon√≠vel para esta guia.");
            return;
          }

          alert(`C√≥digo AT atualizado: ${data.at_code}`);
          carregarGuias(); // recarrega para mostrar novo c√≥digo na tabela
        } catch (err) {
          alert("Erro ao atualizar c√≥digo AT automaticamente: " + err.message);
          console.error(err);
        }
      }
      async function definirCodigoAT(document_id) {
        const codigo = prompt(
          `Introduz o novo c√≥digo AT para a guia ID ${document_id}`
        );
        if (!codigo) return;

        try {
          const res = await fetch(`/molo/guias/${document_id}/codigo-at`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ transport_code: codigo }),
          });

          const text = await res.text();

          let result;
          try {
            result = JSON.parse(text);
          } catch (e) {
            console.error("Resposta n√£o JSON:", text);
            alert("Erro inesperado (resposta n√£o JSON):\n" + text);
            return;
          }

          if (!res.ok) {
            alert(
              "Erro ao atualizar c√≥digo AT: " +
                (result.detalhe || "Erro desconhecido")
            );
            return;
          }

          alert("C√≥digo AT atualizado com sucesso!");
          carregarGuias();
        } catch (err) {
          alert("Erro ao atualizar c√≥digo AT: " + err.message);
        }
      }
      document.addEventListener("DOMContentLoaded", carregarGuias);
    </script>
  </body>
</html>
